<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8" />
<title>QKDE Cosmology Tools – Interactive Calculator Suite</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ================= MATHJAX ================= -->
<script>
  window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- ================= CHART.JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg-body: #020713;
  --bg-page: rgba(12,18,28,0.9);
  --bg-card: rgba(12,18,28,0.82);
  --bg-card-wide: rgba(12,18,28,0.88);
  --bg-input: rgba(5,10,18,0.9);
  --bg-output: rgba(0,0,0,0.55);
  --bg-formula: rgba(8,12,20,0.95);

  --border-card: rgba(102,252,241,0.14);
  --border-card-wide: rgba(102,252,241,0.18);
  --border-input: rgba(120,160,190,0.7);
  --border-output: rgba(120,160,190,0.36);
  --border-formula: rgba(120,160,190,0.45);

  --text-main: #e8e9ef;
  --text-muted: #c0d6f5;
  --text-accent: #66fcf1;
  --text-heading: #bfe9ff;
  --text-heading-strong: #d6f7ff;

  --chip-bg: rgba(8,14,22,0.95);
  --chip-border: rgba(160,220,255,0.5);
  --chip-bg-active1: #66fcf1;
  --chip-bg-active2: #45b9d9;
  --chip-text-active: #031016;

  --btn-bg1: #d2f2ff;
  --btn-bg2: #bfe6f7;
  --btn-border: rgba(200,240,255,0.8);

  --shadow-card: 0 0 35px rgba(102,252,241,0.15);
  --shadow-inner: inset 0 0 18px rgba(102,252,241,0.06);

  --error-bg: rgba(70,0,10,0.7);
  --error-text: #ffe6e6;

  --link-color: #66fcf1;
}

/* Light theme overrides */
:root[data-theme="light"] {
  --bg-body: #f6f7fb;
  --bg-page: #ffffff;
  --bg-card: #f9fbff;
  --bg-card-wide: #f9fbff;
  --bg-input: #ffffff;
  --bg-output: #f2f4fb;
  --bg-formula: #f5f7ff;

  --border-card: rgba(20,60,120,0.10);
  --border-card-wide: rgba(20,60,120,0.18);
  --border-input: rgba(120,160,190,0.7);
  --border-output: rgba(120,160,190,0.36);
  --border-formula: rgba(120,160,190,0.45);

  --text-main: #1b2540;
  --text-muted: #4b5a7a;
  --text-accent: #0077aa;
  --text-heading: #133a67;
  --text-heading-strong: #0f2b4b;

  --chip-bg: #ffffff;
  --chip-border: rgba(30,80,140,0.4);
  --chip-bg-active1: #0f9bdc;
  --chip-bg-active2: #16c3c6;
  --chip-text-active: #ffffff;

  --btn-bg1: #0f9bdc;
  --btn-bg2: #16c3c6;
  --btn-border: rgba(0,120,190,0.8);

  --shadow-card: 0 10px 24px rgba(15, 50, 90, 0.15);
  --shadow-inner: inset 0 0 0 rgba(0,0,0,0);

  --error-bg: rgba(220,40,40,0.12);
  --error-text: #7a0012;

  --link-color: #0f9bdc;
}

/* ---- Global background + typography ---- */
body {
  background: var(--bg-body);
  margin: 0;
  padding: 0;
  color: var(--text-main);
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  line-height: 1.6;
}

/* ================= HEADER ================= */
.site-header {
 
  max-width: 1100px;
  margin: 16px auto 0;
  padding: 10px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.site-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.site-header a {
  color: var(--link-color);
  font-size: 0.9rem;
  text-decoration: none;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid rgba(102,252,241,0.3);
}

:root[data-theme="light"] .site-header a {
  border-color: rgba(0,120,190,0.35);
}

.site-header a:hover {
  background: rgba(102,252,241,0.15);
}

:root[data-theme="light"] .site-header a:hover {
  background: rgba(15,155,220,0.08);
}

/* Theme toggle button */
.theme-toggle {
  border-radius: 999px;
  border: 1px solid rgba(102,252,241,0.3);
  background: transparent;
  color: var(--text-main);
  font-size: 0.85rem;
  padding: 6px 14px;
  cursor: pointer;
}
.theme-toggle:hover {
  background: rgba(102,252,241,0.14);
}

:root[data-theme="light"] .theme-toggle {
  border-color: rgba(0,120,190,0.35);
}
:root[data-theme="light"] .theme-toggle:hover {
  background: rgba(15,155,220,0.08);
}

/* ================= MAIN PAGE WRAPPER ================= */
.page {
  max-width: 1100px;
  width: 100%;
  margin: 8px auto 32px;
  padding: 28px 24px 32px;

  background: var(--bg-page);
  border-radius: 18px;
  border: 1px solid var(--border-card);
  box-shadow: var(--shadow-card);
  backdrop-filter: blur(10px);

  box-sizing: border-box;
  overflow-x: hidden;    /* <--- THIS IS THE CRITICAL FIX */
}

/* ---- Header ---- */
h1 {
  text-align: center;
  font-family: "Merriweather", Georgia, serif;
  font-weight: 300;
  font-size: 2rem;
  color: var(--text-heading);
  margin-bottom: 6px;
}
h2, h3, h4 {
  font-family: "Merriweather", Georgia, serif;
  font-weight: 300;
  color: var(--text-heading);
}

.center { text-align: center; }

.calc-intro {
  font-size: 0.95rem;
  opacity: 0.95;
  margin-bottom: 18px;
  max-width: 860px;
  margin-left: auto;
  margin-right: auto;
  color: var(--text-muted);
}

/* ============================================================
   GRID / CARD LAYOUT
============================================================ */
.calc-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 22px;
  justify-content: center;
  margin-top: 14px;
}

/* Collapsible panels wrapper */
.calc-panel {
  width: 100%;
  margin-bottom: 10px;
}

/* Panel header with title + toggle */
.calc-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.calc-panel-title {
  font-size: 0.95rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-heading-strong);
}

.panel-toggle-btn {
  font-size: 0.78rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(120,160,190,0.7);
  background: transparent;
  color: var(--text-main);
  cursor: pointer;
}
.panel-toggle-btn:hover {
  background: rgba(102,252,241,0.12);
}

/* Panel body collapsible */
.calc-panel-body {
  transition: max-height 0.4s ease, opacity 0.3s ease;
  overflow: hidden;
}

.calc-panel.collapsed .calc-panel-body {
  max-height: 0;
  opacity: 0;
  pointer-events: none;
}

/* A generous default max-height so content fits before collapse */
.calc-panel:not(.collapsed) .calc-panel-body {
  max-height: 10000px;
  opacity: 1;
}

/* Calculator card itself */
.calc-card {
  flex: 1 1 260px;
  max-width: 100%;
  background: radial-gradient(circle at 0% 0%, rgba(102,252,241,0.12) 0, transparent 55%),
              radial-gradient(circle at 120% 120%, rgba(102,252,241,0.10) 0, transparent 55%),
              var(--bg-card);
  padding: 18px 20px 20px;
  border-radius: 16px;
  border: 1px solid var(--border-card);
  box-shadow: 0 0 22px rgba(102,252,241,0.12), var(--shadow-inner);
  transition: 0.25s ease;
  position: relative;
  overflow: hidden;
}
.calc-card::before {
  content: "";
  position: absolute;
  top: 0; left: 0;
  height: 3px;
  width: 100%;
  background: linear-gradient(
    to right,
    rgba(102,252,241,0.85),
    rgba(79,160,201,0.6),
    rgba(102,252,241,0.85)
  );
}
.calc-card:hover {
  border-color: rgba(102,252,241,0.28);
  transform: translateY(-2px);
}

/* Header row inside cards */
.calc-header-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 8px 12px;
  margin-bottom: 8px;
}

.calc-header-row h3 {
  margin: 0;
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--text-heading-strong);
}

/* Misc text */
.calc-note {
  font-size: 0.85rem;
  opacity: 0.9;
  margin-bottom: 10px;
}

/* ============================================================
   INPUTS + LABELS
============================================================ */
.calc-input-row {
  display: grid;
  gap: 8px 10px;
  grid-template-columns: 1fr 1fr;
}
@media (max-width: 700px) {
  .calc-input-row {
    grid-template-columns: 1fr;
  }
}

.calc-label {
  display: block;
  margin-bottom: 3px;
  font-size: 0.82rem;
  text-transform: uppercase;
  color: var(--text-heading);
  letter-spacing: 0.05em;
}

.calc-input {
  width: 100%;
  padding: 7px 10px;
  border-radius: 7px;
  border: 1px solid var(--border-input);
  background: var(--bg-input);
  color: var(--text-main);
  font-size: 0.9rem;
  box-sizing: border-box;
}
.calc-input:focus {
  outline: none;
  border-color: var(--text-accent);
}

/* Select shares style */
select.calc-input {
  padding-right: 26px;
}

/* ============================================================
   BUTTONS
============================================================ */
.calc-action-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 14px;
}

.calc-btn {
  background: linear-gradient(135deg, var(--btn-bg1), var(--btn-bg2));
  border: 1px solid var(--btn-border);
  border-radius: 999px;
  color: #031016;
  cursor: pointer;
  font-size: 0.86rem;
  font-weight: 500;
  letter-spacing: 0.04em;
  padding: 8px 16px;
  text-transform: uppercase;
  transition: transform 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
}
.calc-btn:hover {
  background: linear-gradient(135deg, #e6f6ff, #d7f0ff);
  box-shadow: 0 0 12px rgba(210,240,255,0.75);
  transform: translateY(-1px);
}
.calc-btn.secondary {
  background: transparent;
  border-color: rgba(140,200,255,0.7);
  color: var(--text-main);
}
.calc-btn.secondary:hover {
  background: rgba(10,20,32,0.9);
  color: #c8f3ff;
}

/* ============================================================
   OUTPUT BOXES
============================================================ */
.calc-output,
.calc-output-mini {
  margin-top: 12px;
  background: var(--bg-output);
  border: 1px solid var(--border-output);
  border-radius: 10px;
  padding: 10px;
  font-family: "JetBrains Mono", Menlo, Consolas, monospace;
  font-size: 0.8rem;
  white-space: pre-wrap;
  overflow-y: auto;
  max-height: 10000px;
}
.calc-output-mini {
  max-height: 1100px;
}

.calc-output.error {
  background: var(--error-bg);
  color: var(--error-text);
}

/* ============================================================
   FORMULA BOXES
============================================================ */
.calc-formula-box {
  margin-top: 10px;
  background: var(--bg-formula);
  border: 1px solid var(--border-formula);
  border-radius: 8px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, padding 0.3s ease, opacity 0.3s ease;
  padding: 0 10px;
  opacity: 0;
}
.calc-formula-box.is-open {
  max-height: 1100px;
  padding: 10px;
  opacity: 1;
}
.calc-formula-inner {
  overflow-x: auto;
}

/* ============================================================
   PRESET PILLS
============================================================ */
.calc-pill-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.calc-pill {
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid var(--chip-border);
  font-size: 0.72rem;
  text-transform: uppercase;
  cursor: pointer;
  background: var(--chip-bg);
  color: var(--text-muted);
}
.calc-pill:hover {
  background: rgba(65,190,220,0.2);
}
.calc-pill.is-active {
  background: linear-gradient(135deg, var(--chip-bg-active1), var(--chip-bg-active2));
  color: var(--chip-text-active);
  border-color: rgba(200,240,255,0.9);
}

/* ============================================================
   ADVANCED FULL-WIDTH COMPARATOR
============================================================ */
.calc-card-wide {
  width: 100%;
  max-width: 100%;
  overflow-x: auto;     /* <<< critical fix */
  overflow-y: visible;

  margin-top: 32px;
  padding: 28px 24px 32px;

  background: radial-gradient(circle at 0% 50%, rgba(102,252,241,0.10) 0, transparent 70%),
              radial-gradient(circle at 100% 50%, rgba(102,252,241,0.08) 0, transparent 70%),
              var(--bg-card-wide);
  border-radius: 18px;
  border: 1px solid var(--border-card-wide);
  box-shadow: 0 0 26px rgba(102,252,241,0.16), inset 0 0 22px rgba(102,252,241,0.06);
  position: relative;
}

.calc-card-wide h3 {
  margin-top: 0;
  font-size: 1.05rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--text-heading-strong);
  margin-bottom: 10px;
}

.calc-card-wide canvas {
  width: 100%;
  height: auto;                /* NEW */
  aspect-ratio: 16 / 9;        /* NEW */

  margin-top: 16px;
  border-radius: 10px;
  background: rgba(0,0,0,0.25);
  padding: 8px;
  box-shadow:
      0 0 14px rgba(102,252,241,0.10),
      inset 0 0 12px rgba(102,252,241,0.05);
}

/* Info box under plot */
#adv-growth-info {
  margin-top: 16px;
}

/* Footnote */
.calc-footnote {
  font-size: 0.85rem;
  opacity: 0.9;
  margin-top: 20px;
  color: var(--text-muted);
}
</style>
</head>

<body id="top">

<!-- ================= HEADER WITH NAV + THEME TOGGLE ================= -->
<header class="site-header">
  <div class="site-header-left">
    <a href="index.html">← Back to Home</a>
  </div>
  <!-- Label shows the mode you can switch TO -->
  <button id="theme-toggle" class="theme-toggle" type="button">Light mode</button>
</header>

<div class="page">

  <!-- ================= TITLE ================= -->
  <h1>QKDE Interactive Calculator Suite</h1>
  <p class="center" style="opacity:0.9;">ΛCDM • QKDE • Growth • Kinetic Drift Tools</p>

  <p class="calc-intro">
    These tools implement exact GR background and linear-growth equations for simple dark-energy models,
    and a running kinetic normalization for QKDE. Use them to compare ΛCDM, constant-w quintessence,
    CPL-type k-essence, and QKDE’s kinetic drift at the level of <em>H(a)</em>, distances, and growth.
  </p>

  <!-- ============================================================
       PANEL 1B: ΛCDM BACKGROUND DASHBOARD (ADVANCED)
  ============================================================ -->
  <section class="calc-panel" id="panel-lcdm">
    <div class="calc-panel-header">
      <div class="calc-panel-title">ΛCDM background + distances</div>
      <button class="panel-toggle-btn" data-panel="panel-lcdm" type="button">Hide</button>
    </div>
    <div class="calc-panel-body">
      <article class="calc-card" id="lcdm-card">
        <div class="calc-header-row">
          <h3>ΛCDM Background &amp; Distances</h3>
          <div class="calc-pill-row">
            <button class="calc-pill is-active" data-lcdm-preset="planck">Planck 2018</button>
            <button class="calc-pill" data-lcdm-preset="local">Local H₀ (SH0ES-like)</button>
            <button class="calc-pill" data-lcdm-preset="wmap">WMAP-like</button>
          </div>
        </div>

        <h4>ΛCDM with optional curvature (background + lightcone)</h4>
        <p class="calc-note">
          Computes the standard ΛCDM background from \(\{H_0,\Omega_{m0},\Omega_{r0},\Omega_{\Lambda0}\}\),
          allowing a derived curvature \(\Omega_{k0}=1-\Omega_{m0}-\Omega_{r0}-\Omega_{\Lambda0}\) when flatness
          is not enforced. Outputs \(E(z)\), \(H(z)\), comoving distances, angular and luminosity distances,
          SN distance modulus \(\mu(z)\), the density fractions \(\Omega_i(z)\), lookback time \(t_L(z)\),
          age of the Universe \(t_0\), BAO distance \(D_V(z)\), and the comoving volume element
          \(dV/dz\,d\Omega\).
        </p>

        <!-- Core parameter inputs -->
        <div class="calc-input-row">
          <div>
            <label class="calc-label">Evaluation redshift z</label>
            <input id="lcdm-z" class="calc-input" type="number" value="0.5" step="0.01" min="0">
          </div>
          <div>
            <label class="calc-label">H₀ [km/s/Mpc]</label>
            <input id="lcdm-h0" class="calc-input" type="number" value="67.4" step="0.1" min="10">
          </div>
          <div>
            <label class="calc-label">Ωₘ₀</label>
            <input id="lcdm-om" class="calc-input" type="number" value="0.315" step="0.001" min="0" max="2">
          </div>
          <div>
            <label class="calc-label">Ωᵣ₀</label>
            <input id="lcdm-or" class="calc-input" type="number" value="5e-5" step="1e-5" min="0" max="0.01">
          </div>
          <div>
            <label class="calc-label">ΩΛ₀</label>
            <input id="lcdm-ol" class="calc-input" type="number" value="0.68495" step="0.0001" min="0" max="2">
          </div>
          <div>
            <label class="calc-label">z-steps (for χ, t)</label>
            <input id="lcdm-steps" class="calc-input" type="number" value="600" step="100" min="200">
          </div>
        </div>

        <!-- Constraints + meta controls -->
        <div class="calc-input-row" style="margin-top:6px;">
          <div>
            <label class="calc-label">Flatness constraint</label>
            <label style="font-size:0.8rem; opacity:0.9;">
              <input type="checkbox" id="lcdm-flat" checked>
              Enforce Ωₘ₀ + Ωᵣ₀ + ΩΛ₀ = 1 (Ωₖ₀ → 0, auto-adjust ΩΛ₀)
            </label>
          </div>
          <div>
            <label class="calc-label">Standard radiation</label>
            <label style="font-size:0.8rem; opacity:0.9;">
              <input type="checkbox" id="lcdm-auto-rad" checked>
              Use standard \(T_{\rm CMB}=2.7255\,\mathrm{K}\), \(N_{\rm eff}=3.046\)
            </label>
          </div>
          <div>
            <label class="calc-label">Derived Ωₖ₀</label>
            <input id="lcdm-ok" class="calc-input" type="text" value="0" disabled>
          </div>
          <div>
            <label class="calc-label">Plot z<sub>max</sub></label>
            <input id="lcdm-zmax-plot" class="calc-input" type="number" value="3" step="0.5" min="0.1">
          </div>
        </div>

        <div class="calc-input-row" style="margin-top:6px;">
          <div>
            <label class="calc-label">Quantity to plot</label>
            <select id="lcdm-plot-y" class="calc-input">
              <option value="E">E(z)</option>
              <option value="H">H(z)/H₀</option>
              <option value="DC">D_C(z) [Mpc]</option>
              <option value="DM">D_M(z) [Mpc]</option>
              <option value="DA">D_A(z) [Mpc]</option>
              <option value="DL">D_L(z) [Mpc]</option>
            </select>
          </div>
          <div>
            <label class="calc-label">Export grid</label>
            <p style="font-size:0.78rem; margin:0; opacity:0.9;">
              Use the CSV button to download a z–distance table for external analysis.
            </p>
          </div>
        </div>

        <div class="calc-action-row">
          <button class="calc-btn" id="lcdm-compute" type="button">Compute ΛCDM</button>
          <button class="calc-btn secondary" id="lcdm-export-csv" type="button">Export z-grid (CSV)</button>
          <button class="calc-btn secondary" id="lcdm-formula-toggle" type="button">Show formulas</button>
        </div>

        <!-- Compact numerical output -->
        <pre id="lcdm-output" class="calc-output"></pre>

        <!-- Small diagnostic plot -->
        <canvas id="lcdm-canvas" style="margin-top:12px; max-height:260px;"></canvas>

        <!-- Formulas -->
        <div id="lcdm-formulas" class="calc-formula-box" aria-hidden="true">
          <div class="calc-formula-inner">
            <p>\(\Omega_{k0} = 1-\Omega_{m0}-\Omega_{r0}-\Omega_{\Lambda0}\)</p>
            <p>\(E(z)=\sqrt{\Omega_{m0}(1+z)^3 + \Omega_{r0}(1+z)^4
                + \Omega_{k0}(1+z)^2 + \Omega_{\Lambda0}}\)</p>
            <p>\(H(z)=H_0 E(z)\)</p>
            <p>\(D_H = c/H_0\)</p>
            <p>\(D_C(z)=D_H \displaystyle\int_0^z \frac{dz'}{E(z')}\)</p>
            <p>
              \(S_k(\chi) =
              \begin{cases}
                \frac{1}{\sqrt{\Omega_{k0}}}\sinh(\sqrt{\Omega_{k0}}\,\chi) & \Omega_{k0}>0 \\
                \chi & \Omega_{k0}=0 \\
                \frac{1}{\sqrt{|\Omega_{k0}|}}\sin(\sqrt{|\Omega_{k0}|}\,\chi) & \Omega_{k0}<0
              \end{cases}\)
            </p>
            <p>\(D_M(z)=D_H\,S_k\!\left(\displaystyle\int_0^z \frac{dz'}{E(z')}\right)\)</p>
            <p>\(D_A(z)=D_M/(1+z), \quad D_L(z)=(1+z)D_M\)</p>
            <p>\(\mu(z) = 5\log_{10}(D_L/\mathrm{Mpc}) + 25\)</p>
            <p>\(\Omega_m(z) = \dfrac{\Omega_{m0}(1+z)^3}{E(z)^2}\), similarly for \(\Omega_r(z),\Omega_\Lambda(z),\Omega_k(z)\).</p>
            <p>\(t_L(z) = \displaystyle\int_0^z \frac{dz'}{(1+z')H(z')}\), \quad
               \(t_0 = \displaystyle\int_0^{z_{\rm max}}\frac{dz'}{(1+z')H(z')}\)</p>
            <p>\(D_V(z) = \left[ (1+z)^2 D_A^2 \frac{cz}{H(z)}\right]^{1/3}\)</p>
            <p>\(\frac{dV}{dz\,d\Omega} = \frac{c}{H(z)} D_M^2\)</p>
          </div>
        </div>
      </article>
    </div>
  </section>

  <!-- ============================================================
       PANEL 2: QKDE RUNNING K
  ============================================================ -->
  <section class="calc-panel" id="panel-qkde">
    <div class="calc-panel-header">
      <div class="calc-panel-title">QKDE running kinetic normalization</div>
      <button class="panel-toggle-btn" data-panel="panel-qkde" type="button">Hide</button>
    </div>
    <div class="calc-panel-body">
      <article class="calc-card" id="qkde-card">
        <div class="calc-header-row">
          <h3>QKDE Running K</h3>
          <div class="calc-pill-row">
            <button class="calc-pill is-active" data-qkde-preset="mild">Mild drift</button>
            <button class="calc-pill" data-qkde-preset="strong">Strong drift</button>
          </div>
        </div>

        <h4>Running kinetic normalization</h4>
        <p class="calc-note">
          Implements \(K(N)=1+K_0 e^{-pN}\), with \(N=\ln a=-\ln(1+z)\). This encodes a slow background
          drift in the kinetic sector while the metric and growth equations remain exactly GR.
        </p>

        <div class="calc-input-row">
          <div>
            <label class="calc-label">Redshift z</label>
            <input id="qkde-z" class="calc-input" value="0.5" type="number" step="0.01">
          </div>
          <div>
            <label class="calc-label">K₀</label>
            <input id="qkde-k0" class="calc-input" value="0.5" type="number" step="0.05">
          </div>
          <div>
            <label class="calc-label">p</label>
            <input id="qkde-p" class="calc-input" value="1.0" type="number" step="0.1">
          </div>
          <div>
            <label class="calc-label">Reference K(0)</label>
            <input id="qkde-kref" class="calc-input" value="1.0" type="number" step="0.01">
          </div>
        </div>

        <div class="calc-action-row">
          <button class="calc-btn" id="qkde-compute" type="button">Compute K(z)</button>
          <button class="calc-btn secondary" id="qkde-formula-toggle" type="button">Show definitions</button>
        </div>

        <pre id="qkde-output" class="calc-output"></pre>

        <div id="qkde-formulas" class="calc-formula-box" aria-hidden="true">
          <div class="calc-formula-inner">
            <p>\(N = -\ln(1+z)\)</p>
            <p>\(K(N) = 1 + K_0 e^{-pN}\)</p>
            <p>\(K'(N)/K(N) = -pK_0 e^{-pN}/K(N)\)</p>
            <p>Today (z=0, N=0): \(K(0)=1+K_0\)</p>
          </div>
        </div>
      </article>
    </div>
  </section>

  <!-- ============================================================
       PANEL 3: GR GROWTH AT ONE REDSHIFT
  ============================================================ -->
  <section class="calc-panel" id="panel-growth">
    <div class="calc-panel-header">
      <div class="calc-panel-title">GR linear growth factor</div>
      <button class="panel-toggle-btn" data-panel="panel-growth" type="button">Hide</button>
    </div>
    <div class="calc-panel-body">
      <article class="calc-card" id="growth-card">
        <div class="calc-header-row">
          <h3>GR Growth D(a)</h3>
          <span class="calc-pill is-active" style="cursor:default;">GR Only</span>
        </div>

        <h4>Linear growth at the ΛCDM background</h4>
        <p class="calc-note">
          Solves the GR growth equation \(D'' + (2+H'/H)D' - \tfrac32 \Omega_m(a)D = 0\) in \(N=\ln a\)
          using the ΛCDM parameters from the first card (or custom values below). Growth is normalized
          to \(D(0)=1\).
        </p>

        <div class="calc-input-row">
          <div>
            <label class="calc-label">Ωₘ₀ (growth)</label>
            <input id="grow-om0" class="calc-input" value="0.3" type="number" step="0.001">
          </div>
          <div>
            <label class="calc-label">Ωᵣ₀ (growth)</label>
            <input id="grow-or0" class="calc-input" value="0" type="number" step="1e-5">
          </div>
          <div>
            <label class="calc-label">ΩΛ₀ (growth)</label>
            <input id="grow-ol0" class="calc-input" value="0.7" type="number" step="0.001">
          </div>
          <div>
            <label class="calc-label">Use z from ΛCDM card</label>
            <input class="calc-input" value="linked" disabled>
          </div>
        </div>

        <div class="calc-action-row">
          <button class="calc-btn" id="grow-compute" type="button">Compute D(z)</button>
          <button class="calc-btn secondary" id="grow-formula-toggle" type="button">Show equation</button>
        </div>

        <pre id="grow-output" class="calc-output-mini"></pre>

        <div id="grow-formulas" class="calc-formula-box" aria-hidden="true">
          <div class="calc-formula-inner">
            <p>\( D'' + (2 + H'/H)D' - \frac{3}{2}\Omega_m(a)D = 0 \)</p>
            <p>where primes are derivatives with respect to \(N=\ln a\).</p>
          </div>
        </div>
      </article>
    </div>
  </section>

  <!-- ============================================================
       PANEL 4: ΛCDM vs QKDE AT ONE z
  ============================================================ -->
  <section class="calc-panel" id="panel-compare">
    <div class="calc-panel-header">
      <div class="calc-panel-title">ΛCDM vs QKDE snapshot</div>
      <button class="panel-toggle-btn" data-panel="panel-compare" type="button">Hide</button>
    </div>
    <div class="calc-panel-body">
      <article class="calc-card" id="compare-card">
        <div class="calc-header-row">
          <h3>ΛCDM vs QKDE</h3>
          <div class="calc-pill-row">
            <span class="calc-pill is-active" style="cursor:default;">Quick comparison</span>
          </div>
        </div>

        <h4>Snapshot comparison at one redshift</h4>
        <p class="calc-note">
          Compares ΛCDM distances with the QKDE kinetic normalization and GR growth at the same redshift.
          Uses ΛCDM parameters from the first card and QKDE parameters below.
        </p>

        <div class="calc-input-row">
          <div>
            <label class="calc-label">Redshift z</label>
            <input id="cmp-z" class="calc-input" value="0.5" type="number" step="0.01">
          </div>
          <div>
            <label class="calc-label">K₀</label>
            <input id="cmp-k0" class="calc-input" value="0.5" type="number" step="0.05">
          </div>
          <div>
            <label class="calc-label">p</label>
            <input id="cmp-p" class="calc-input" value="1.0" type="number" step="0.1">
          </div>
          <div>
            <label class="calc-label">Reference K(0)</label>
            <input id="cmp-kref" class="calc-input" value="1.0" type="number" step="0.01">
          </div>
        </div>

        <div class="calc-action-row">
          <button class="calc-btn" id="cmp-compute" type="button">Compare at z</button>
        </div>

        <pre id="cmp-output" class="calc-output-mini"></pre>
      </article>
    </div>
  </section>

  <!-- ============================================================
       ADVANCED FULL-WIDTH COMPARATOR
  ============================================================ -->
  <section class="calc-panel" id="panel-advanced">
    <div class="calc-panel-header">
      <div class="calc-panel-title">Growth comparator: ΛCDM vs quintessence vs CPL vs QKDE</div>
      <button class="panel-toggle-btn" data-panel="panel-advanced" type="button">Hide</button>
    </div>
    <div class="calc-panel-body">
      <article class="calc-card-wide" id="advanced-growth-card">
        <h3>Growth Comparator (ΛCDM / Quintessence / CPL / QKDE)</h3>
        <p class="calc-note">
          Solves the GR growth equation for three standard background families
          (ΛCDM, constant-w quintessence, CPL \(w(a)=w_0+w_a(1-a)\)) and a
          QKDE-inspired background where dark-energy density scales as
          \(\rho_{\rm DE}(a)\propto K(1)/K(a)\). Growth is always computed with
          the exact GR equation on each background.
        </p>

        <div class="calc-input-row">
          <div>
            <label class="calc-label">Ωₘ₀</label>
            <input id="adv-om0" class="calc-input" value="0.3" type="number" step="0.001">
          </div>
          <div>
            <label class="calc-label">Ωᵣ₀</label>
            <input id="adv-or0" class="calc-input" value="0" type="number" step="1e-5">
          </div>
          <div>
            <label class="calc-label">z<sub>max</sub></label>
            <input id="adv-zmax" class="calc-input" value="3" type="number" step="0.1">
          </div>
          <div>
            <label class="calc-label">Samples</label>
            <input id="adv-samples" class="calc-input" value="120" type="number" min="40" step="10">
          </div>
        </div>

        <div class="calc-input-row">
          <div>
            <label class="calc-label">w<sub>Q</sub> (quintessence)</label>
            <input id="adv-wq" class="calc-input" value="-0.9" type="number" step="0.05">
          </div>
          <div>
            <label class="calc-label">w₀ (CPL)</label>
            <input id="adv-w0" class="calc-input" value="-0.9" type="number" step="0.05">
          </div>
          <div>
            <label class="calc-label">wₐ (CPL)</label>
            <input id="adv-wa" class="calc-input" value="0.2" type="number" step="0.05">
          </div>
          <div>
            <label class="calc-label">Models</label>
            <label><input type="checkbox" id="adv-show-lcdm" checked> ΛCDM</label><br>
            <label><input type="checkbox" id="adv-show-quint" checked> Quintessence</label><br>
            <label><input type="checkbox" id="adv-show-kess" checked> CPL-type k-essence</label><br>
            <label><input type="checkbox" id="adv-show-qkde" checked> QKDE (ρ∝K(1)/K(a))</label>
          </div>
        </div>

        <div class="calc-input-row">
          <div>
            <label class="calc-label">x-axis</label>
            <select id="adv-xaxis" class="calc-input">
              <option value="a">Scale factor a</option>
              <option value="z">Redshift z</option>
            </select>
          </div>
          <div>
            <label class="calc-label">Normalization</label>
            <select id="adv-norm" class="calc-input">
              <option value="Da">D(a) with D(1)=1</option>
              <option value="Da_over_a">D(a)/a</option>
            </select>
          </div>
          <div>
            <label class="calc-label">K₀ (QKDE)</label>
            <input id="adv-k0q" class="calc-input" value="0.5" type="number" step="0.05">
          </div>
          <div>
            <label class="calc-label">p (QKDE)</label>
            <input id="adv-pq" class="calc-input" value="1.0" type="number" step="0.1">
          </div>
        </div>

        <div class="calc-action-row">
          <button class="calc-btn" id="adv-growth-compute" type="button">Plot growth</button>
          <button class="calc-btn secondary" id="adv-export-csv" type="button">
  Export growth (CSV)
</button>
        </div>

        <canvas id="adv-growth-canvas"></canvas>
        <pre id="adv-growth-info" class="calc-output-mini"></pre>

        <p class="calc-footnote">
          In this comparator, QKDE is implemented as an effective background with
          \(\rho_{\rm DE}(a)=\rho_{\rm DE,0}\,K(1)/K(a)\), where \(K(a)=1+K_0 a^{-p}\) and
          \(K(1)=1+K_0\). This corresponds to an effective equation of state
          \(w(a)=-1-\tfrac{1}{3}\,d\ln K/d\ln a\), so that ΛCDM is recovered when \(K\) is constant.
          The GR growth equation is then solved on this background exactly, and compared with
          ΛCDM, constant-w quintessence, and CPL tracks.
        </p>
      </article>
    </div>
  </section>

</div> <!-- /page -->

<!-- ================= JS (wrapped in DOMContentLoaded) ================= -->
<script>
// qkde-tools.js
(function () {
  "use strict";

  // ============================================================
  // BASIC DOM HELPERS
  // ============================================================
  function byId(id) {
    return document.getElementById(id);
  }

  function setOutput(el, text, isError = false) {
    if (!el) return;
    el.textContent = text;
    if (isError) {
      el.classList.add("error");
    } else {
      el.classList.remove("error");
    }
  }

  function attachFormulaToggle(btnId, boxId) {
    const btn = byId(btnId);
    const box = byId(boxId);
    if (!btn || !box) return;

    btn.addEventListener("click", () => {
      const open = box.classList.toggle("is-open");
      box.setAttribute("aria-hidden", open ? "false" : "true");

      if (btn.dataset.altLabelOpen && btn.dataset.altLabelClosed) {
        btn.textContent = open ? btn.dataset.altLabelOpen : btn.dataset.altLabelClosed;
      } else {
        btn.textContent = open ? "Hide formulas" : "Show formulas";
      }

      if (window.MathJax) {
        if (MathJax.typesetPromise) {
          MathJax.typesetPromise([box]).catch(() => {});
        } else if (MathJax.typeset) {
          MathJax.typeset([box]);
        }
      }
    });
  }

  // ============================================================
  // PHYSICAL CONSTANTS
  // ============================================================
  const C_LIGHT = 299792.458; // km/s
  const MPC_IN_KM = 3.085677581e19; // km in 1 Mpc
  const SEC_PER_GYR = 3.15576e16; // s in 1 Gyr

  // ============================================================
  // ΛCDM BACKGROUND FUNCTIONS (with curvature, general Ω's)
  // ============================================================
  function E_z(z, Om0, Or0, Ol0) {
    const Ok0 = 1 - Om0 - Or0 - Ol0;
    const zp1 = 1 + z;
    return Math.sqrt(
      Om0 * zp1 ** 3 +
      Or0 * zp1 ** 4 +
      Ok0 * zp1 ** 2 +
      Ol0
    );
  }

  function E_a(a, Om0, Or0, Ol0) {
    const Ok0 = 1 - Om0 - Or0 - Ol0;
    return Math.sqrt(
      Om0 / (a ** 3) +
      Or0 / (a ** 4) +
      Ok0 / (a ** 2) +
      Ol0
    );
  }

  function standardOmegaR0(H0, Tcmb = 2.7255, Neff = 3.046) {
    // Approx Planck-ish formula for Ω_r0(h, Tcmb, Neff)
    const h = H0 / 100;
    const Omega_gamma_0 = 2.47e-5 * Math.pow(Tcmb / 2.7255, 4) / (h * h);
    return Omega_gamma_0 * (1 + 0.2271 * Neff);
  }

  // Simpson integration helper: ensures even N
  function simpsonIntegrate(fn, x0, x1, N) {
    let n = Math.max(2, N | 0);
    if (n % 2 === 1) n += 1;
    const h = (x1 - x0) / n;
    let sum = 0;
    for (let i = 0; i <= n; i++) {
      const x = x0 + i * h;
      const w = (i === 0 || i === n) ? 1 : (i % 2 === 0 ? 2 : 4);
      sum += w * fn(x);
    }
    return (h / 3) * sum;
  }

  function integrateChiDimless(Om0, Or0, Ol0, zmax, Nsteps) {
    return simpsonIntegrate(
      (z) => 1 / E_z(z, Om0, Or0, Ol0),
      0,
      zmax,
      Math.max(200, Nsteps | 0)
    );
  }

  function lcdmDistancesAtZ(H0, Om0, Or0, Ol0, z, Nsteps) {
    const Ok0 = 1 - Om0 - Or0 - Ol0;
    const DH = C_LIGHT / H0; // Mpc
    const chiDimless = integrateChiDimless(Om0, Or0, Ol0, z, Nsteps);
    const DC = DH * chiDimless;

    let DM;
    if (Math.abs(Ok0) < 1e-7) {
      DM = DC;
    } else {
      const sqrtOk = Math.sqrt(Math.abs(Ok0));
      if (Ok0 > 0) {
        DM = DH / sqrtOk * Math.sinh(sqrtOk * chiDimless);
      } else {
        DM = DH / sqrtOk * Math.sin(sqrtOk * chiDimless);
      }
    }

    const DA = DM / (1 + z);
    const DL = DM * (1 + z);
    return { DC, DM, DA, DL };
  }

  function integrateLookbackTime(H0, Om0, Or0, Ol0, zmax, Nsteps) {
    const integral = simpsonIntegrate(
      (z) => 1 / ((1 + z) * E_z(z, Om0, Or0, Ol0)),
      0,
      zmax,
      Math.max(400, Nsteps | 0)
    );
    const H0_s = H0 / MPC_IN_KM; // 1/s
    const t_seconds = integral / H0_s;
    return t_seconds / SEC_PER_GYR; // Gyr
  }

  function computeDv(H0, Om0, Or0, Ol0, z, DA, Ez) {
    const H = H0 * Ez;
    const term = Math.pow(1 + z, 2) * DA * DA * (C_LIGHT * z / H);
    return Math.cbrt(term);
  }

  function differentialVolume(H0, Om0, Or0, Ol0, z, DM, Ez) {
    const H = H0 * Ez;
    return (C_LIGHT / H) * DM * DM;
  }

  // ============================================================
  // QKDE K(a) (Option B background uses this)
  // ============================================================
  // K(N) = 1 + K0 e^{-pN}, N = ln a ⇒ K(a) = 1 + K0 a^{-p}
  function K_a(a, K0, p) {
    return 1 + K0 * Math.pow(a, -p);
  }

  // ============================================================
  // GROWTH SOLVER (GENERAL BACKGROUND)
  // D'' + (2 + H'/H)D' - 3/2 Ω_m(a) D = 0, N = ln a
  // ============================================================
  function solveGrowthArray(aArray, E_func, Om0) {
    if (!aArray.length) return [];

    const a_min = aArray[0];
    const N_start = Math.log(a_min);
    const N_end = 0.0; // ln(1)
    const steps = 1500;
    const dN = (N_end - N_start) / steps;

    // Deep matter era IC: D ∝ a => D(a_min) = a_min, D' = D
    let D = a_min;
    let F = D;
    let N = N_start;

    const results = [];
    let index = 0;
    let a_target = aArray[index];

    function dlnH_dN(a) {
      const E = E_func(a);
      const eps = 1e-5;
      const aPlus = a * (1 + eps);
      const aMinus = a / (1 + eps);
      const EPlus = E_func(aPlus);
      const EMinus = E_func(aMinus);
      const dlnE_dlnA =
        (Math.log(EPlus) - Math.log(EMinus)) /
        (2 * Math.log(1 + eps));
      return dlnE_dlnA;
    }

    function derivs(Nv, Dv, Fv) {
      const a = Math.exp(Nv);
      const E = E_func(a);
      const OmA = (Om0 / (a * a * a)) / (E * E);
      const dlnH = dlnH_dN(a);
      return {
        Dp: Fv,
        Fp: -(2 + dlnH) * Fv + 1.5 * OmA * Dv
      };
    }

    function rkStep(Nv, Dv, Fv, h) {
      const k1 = derivs(Nv, Dv, Fv);
      const k2 = derivs(
        Nv + h / 2,
        Dv + (h * k1.Dp) / 2,
        Fv + (h * k1.Fp) / 2
      );
      const k3 = derivs(
        Nv + h / 2,
        Dv + (h * k2.Dp) / 2,
        Fv + (h * k2.Fp) / 2
      );
      const k4 = derivs(
        Nv + h,
        Dv + h * k3.Dp,
        Fv + h * k3.Fp
      );
      return {
        D:
          Dv +
          (h / 6) *
          (k1.Dp + 2 * k2.Dp + 2 * k3.Dp + k4.Dp),
        F:
          Fv +
          (h / 6) *
          (k1.Fp + 2 * k2.Fp + 2 * k3.Fp + k4.Fp)
      };
    }

    while (index < aArray.length) {
      const N_target = Math.log(a_target);
      if (N < N_target - 1e-10) {
        const step = rkStep(N, D, F, dN);
        D = step.D;
        F = step.F;
        N += dN;
      } else {
        results.push(D);
        index++;
        if (index < aArray.length) {
          a_target = aArray[index];
        }
      }
    }

    // Normalize to D(a=1) = 1
    const D_today = results[results.length - 1];
    return results.map((val) => val / D_today);
  }

  function solveGrowthAtZ_LCDM(z, Om0, Or0, Ol0) {
    const a_target = 1 / (1 + z);
    if (a_target <= 1e-3) {
      throw new Error("Growth solver requires z ≲ 1000 (a ≥ 10⁻³).");
    }

    const a_min = 1e-3;
    const Npts = 400;
    const aArray = Array.from({ length: Npts }, (_, i) =>
      a_min + (1 - a_min) * (i / (Npts - 1))
    );

    const E_LCDM = (a) => E_a(a, Om0, Or0, Ol0);
    const Darr = solveGrowthArray(aArray, E_LCDM, Om0);

    // Nearest index to a_target
    let idx = 0;
    let bestDiff = Infinity;
    for (let i = 0; i < aArray.length; i++) {
      const diff = Math.abs(aArray[i] - a_target);
      if (diff < bestDiff) {
        bestDiff = diff;
        idx = i;
      }
    }

    const Dnorm = Darr[idx];

    // f = d ln D / d ln a
    const i0 = Math.max(1, Math.min(aArray.length - 2, idx));
    const a_minus = aArray[i0 - 1];
    const a_plus = aArray[i0 + 1];
    const D_minus = Darr[i0 - 1];
    const D_plus = Darr[i0 + 1];

    const f =
      (Math.log(D_plus) - Math.log(D_minus)) /
      (Math.log(a_plus) - Math.log(a_minus));

    return { Dnorm, f };
  }

  // ============================================================
  // MAIN INIT
  // ============================================================
  window.addEventListener("DOMContentLoaded", () => {
    // ------------------------------------------------------------
    // Theme toggle
    // ------------------------------------------------------------
    const themeToggle = byId("theme-toggle");
    if (themeToggle) {
      // Restore persisted theme if present
      const storedTheme = localStorage.getItem("qkde-theme");
      if (storedTheme === "light" || storedTheme === "dark") {
        document.documentElement.setAttribute("data-theme", storedTheme);
        themeToggle.textContent =
          storedTheme === "dark" ? "Light mode" : "Dark mode";
      }

      themeToggle.addEventListener("click", () => {
        const root = document.documentElement;
        const current = root.getAttribute("data-theme") || "dark";
        const next = current === "dark" ? "light" : "dark";
        root.setAttribute("data-theme", next);
        themeToggle.textContent =
          next === "dark" ? "Light mode" : "Dark mode";
        localStorage.setItem("qkde-theme", next);
      });
    }

    // ------------------------------------------------------------
    // Panel collapsibles: start all collapsed
    // ------------------------------------------------------------
    document.querySelectorAll(".calc-panel").forEach((panel) => {
      panel.classList.add("collapsed");
    });

    document.querySelectorAll(".panel-toggle-btn").forEach((btn) => {
      btn.textContent = "Show";

      btn.addEventListener("click", () => {
        const panelId = btn.getAttribute("data-panel");
        if (!panelId) return;
        const panel = byId(panelId);
        if (!panel) return;

        panel.classList.toggle("collapsed");
        const isCollapsed = panel.classList.contains("collapsed");
        btn.textContent = isCollapsed ? "Show" : "Hide";
      });
    });

    // ------------------------------------------------------------
    // Formula toggles
    // ------------------------------------------------------------
    attachFormulaToggle("lcdm-formula-toggle", "lcdm-formulas");
    attachFormulaToggle("qkde-formula-toggle", "qkde-formulas");
    attachFormulaToggle("grow-formula-toggle", "grow-formulas");

    // ============================================================
    // PANEL 1B: ΛCDM BACKGROUND DASHBOARD
    // ============================================================
    let lcdmChart = null;

    function updateLCDMChart(params, plotType) {
      const { H0, Om0, Or0, Ol0, zPlotMax, Nchi } = params;

      const Nz = 180;
      const dz = zPlotMax / Nz;

      const zArr = [];
      const EArr = [];
      const HArr = [];
      const DCarr = [];
      const DMarr = [];
      const DAarr = [];
      const DLarr = [];

      for (let i = 0; i <= Nz; i++) {
        const z = i * dz;
        zArr.push(z);
        const Ez = E_z(z, Om0, Or0, Ol0);
        const H = H0 * Ez;
        const dists = lcdmDistancesAtZ(H0, Om0, Or0, Ol0, z, Nchi);

        EArr.push(Ez);
        HArr.push(H / H0);
        DCarr.push(dists.DC);
        DMarr.push(dists.DM);
        DAarr.push(dists.DA);
        DLarr.push(dists.DL);
      }

      let yArr, yLabel;
      switch (plotType) {
        case "H":
          yArr = HArr;
          yLabel = "H(z)/H₀";
          break;
        case "DC":
          yArr = DCarr;
          yLabel = "D_C(z) [Mpc]";
          break;
        case "DM":
          yArr = DMarr;
          yLabel = "D_M(z) [Mpc]";
          break;
        case "DA":
          yArr = DAarr;
          yLabel = "D_A(z) [Mpc]";
          break;
        case "DL":
          yArr = DLarr;
          yLabel = "D_L(z) [Mpc]";
          break;
        case "E":
        default:
          yArr = EArr;
          yLabel = "E(z)";
          break;
      }

      const canvas = byId("lcdm-canvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (lcdmChart) lcdmChart.destroy();

      lcdmChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: zArr.map((v) => v.toFixed(2)),
          datasets: [
            {
              label: yLabel,
              data: yArr,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: "Redshift z" }
            },
            y: {
              title: { display: true, text: yLabel }
            }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    }

    const lcdmComputeBtn = byId("lcdm-compute");
    if (lcdmComputeBtn) {
      lcdmComputeBtn.addEventListener("click", () => {
        try {
          const z = parseFloat(byId("lcdm-z").value);
          let H0 = parseFloat(byId("lcdm-h0").value);
          let Om0 = parseFloat(byId("lcdm-om").value);
          let Or0 = parseFloat(byId("lcdm-or").value);
          let Ol0 = parseFloat(byId("lcdm-ol").value);
          const steps = parseInt(byId("lcdm-steps").value, 10);
          const zPlotMax = parseFloat(byId("lcdm-zmax-plot").value);
          const plotType = byId("lcdm-plot-y").value;
          const autoRad = byId("lcdm-auto-rad").checked;
          const enforceFlat = byId("lcdm-flat").checked;

          if (!(z >= 0)) throw new Error("Redshift z must be ≥ 0.");
          if (!(H0 > 0)) throw new Error("H₀ must be positive.");
          if (!(steps >= 200))
            throw new Error("z-steps must be ≥ 200.");
          if (!(zPlotMax > 0))
            throw new Error("Plot z_max must be > 0.");

          if (autoRad) {
            Or0 = standardOmegaR0(H0);
            byId("lcdm-or").value = Or0.toExponential(3);
          }

          if (enforceFlat) {
            Ol0 = 1 - Om0 - Or0;
            byId("lcdm-ol").value = Ol0.toFixed(6);
          }

          const Ok0 = 1 - Om0 - Or0 - Ol0;
          const okField = byId("lcdm-ok");
          if (okField) okField.value = Ok0.toFixed(6);

          const Otot0 = Om0 + Or0 + Ol0 + Ok0;
          if (!(Otot0 > 0)) {
            throw new Error("Ω_total must be > 0.");
          }

          const Ez = E_z(z, Om0, Or0, Ol0);
          const H = H0 * Ez;
          const dists = lcdmDistancesAtZ(H0, Om0, Or0, Ol0, z, steps);
          const DC = dists.DC;
          const DM = dists.DM;
          const DA = dists.DA;
          const DL = dists.DL;
          const mu = 5 * Math.log10(DL) + 25;

          const E2 = Ez * Ez;
          const zp1 = 1 + z;
          const OmegaMz = (Om0 * zp1 ** 3) / E2;
          const OmegaRz = (Or0 * zp1 ** 4) / E2;
          const OmegaLz = Ol0 / E2;
          const OmegaKz = (Ok0 * zp1 ** 2) / E2;

          const tL = integrateLookbackTime(
            H0,
            Om0,
            Or0,
            Ol0,
            z,
            steps
          );
          const t0 = integrateLookbackTime(
            H0,
            Om0,
            Or0,
            Ol0,
            4000,
            steps * 2
          );
          const t_z = t0 - tL;

          const Dv = computeDv(H0, Om0, Or0, Ol0, z, DA, Ez);
          const dV_dzdO = differentialVolume(
            H0,
            Om0,
            Or0,
            Ol0,
            z,
            DM,
            Ez
          );

          setOutput(
            byId("lcdm-output"),
`=== ΛCDM Background @ z = ${z.toFixed(4)} ===
H₀            = ${H0.toFixed(3)} km/s/Mpc

Ωₘ₀           = ${Om0.toFixed(6)}
Ωᵣ₀           = ${Or0.toExponential(3)}
ΩΛ₀           = ${Ol0.toFixed(6)}
Ωₖ₀           = ${Ok0.toFixed(6)}
Ω_total(0)    = ${Otot0.toFixed(6)}

E(z)          = ${Ez.toFixed(6)}
H(z)          = ${H.toFixed(4)} km/s/Mpc

D_C(z)        = ${DC.toFixed(4)} Mpc  (comoving line-of-sight)
D_M(z)        = ${DM.toFixed(4)} Mpc  (transverse comoving)
D_A(z)        = ${DA.toFixed(4)} Mpc
D_L(z)        = ${DL.toFixed(4)} Mpc
μ(z)          = ${mu.toFixed(4)} mag

Ω_m(z)        = ${OmegaMz.toFixed(6)}
Ω_r(z)        = ${OmegaRz.toExponential(3)}
Ω_Λ(z)        = ${OmegaLz.toFixed(6)}
Ω_k(z)        = ${OmegaKz.toFixed(6)}

t_L(z)        = ${tL.toFixed(3)} Gyr (lookback)
t(z)          = ${t_z.toFixed(3)} Gyr (cosmic time)
t₀            = ${t0.toFixed(3)} Gyr (age of Universe)

D_V(z)        = ${Dv.toFixed(4)} Mpc
dV/dz dΩ      = ${dV_dzdO.toExponential(3)} Mpc³`
          );

          updateLCDMChart(
            {
              H0,
              Om0,
              Or0,
              Ol0,
              zPlotMax,
              Nchi: steps
            },
            plotType
          );
        } catch (err) {
          setOutput(byId("lcdm-output"), err.message, true);
        }
      });
    }

    // ΛCDM presets
    (function attachLCDMPresets() {
      const buttons = document.querySelectorAll(
        "#lcdm-card [data-lcdm-preset]"
      );
      if (!buttons.length) return;

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          buttons.forEach((b) => b.classList.remove("is-active"));
          btn.classList.add("is-active");

          const preset = btn.dataset.lcdmPreset;
          const H0Input = byId("lcdm-h0");
          const OmInput = byId("lcdm-om");
          const OrInput = byId("lcdm-or");
          const OlInput = byId("lcdm-ol");
          const flatBox = byId("lcdm-flat");
          const autoRad = byId("lcdm-auto-rad");

          if (!H0Input || !OmInput || !OrInput || !OlInput) return;

          if (preset === "planck") {
            H0Input.value = 67.4;
            OmInput.value = 0.315;
          } else if (preset === "local") {
            H0Input.value = 73.0;
            OmInput.value = 0.30;
          } else if (preset === "wmap") {
            H0Input.value = 70.0;
            OmInput.value = 0.28;
          }

          autoRad.checked = true;
          const H0 = parseFloat(H0Input.value);
          const Or0 = standardOmegaR0(H0);
          OrInput.value = Or0.toExponential(3);

          flatBox.checked = true;
          const Om0 = parseFloat(OmInput.value);
          const Ol0 = 1 - Om0 - Or0;
          OlInput.value = Ol0.toFixed(6);

          const Ok0 = 1 - Om0 - Or0 - Ol0;
          const okField = byId("lcdm-ok");
          if (okField) okField.value = Ok0.toFixed(6);
        });
      });
    })();

    // CSV export for ΛCDM background
    const lcdmCsvBtn = byId("lcdm-export-csv");
    if (lcdmCsvBtn) {
      lcdmCsvBtn.addEventListener("click", () => {
        try {
          const H0 = parseFloat(byId("lcdm-h0").value);
          const Om0 = parseFloat(byId("lcdm-om").value);
          let Or0 = parseFloat(byId("lcdm-or").value);
          let Ol0 = parseFloat(byId("lcdm-ol").value);
          const autoRad = byId("lcdm-auto-rad").checked;
          const enforceFlat = byId("lcdm-flat").checked;
          const zPlotMax = parseFloat(
            byId("lcdm-zmax-plot").value
          );

          if (!(H0 > 0)) throw new Error("H₀ must be positive.");
          if (!(zPlotMax > 0))
            throw new Error("Plot z_max must be > 0.");

          if (autoRad) Or0 = standardOmegaR0(H0);
          if (enforceFlat) Ol0 = 1 - Om0 - Or0;

          const Nz = 200;
          const dz = zPlotMax / Nz;

          const rows = [];
          rows.push(
            [
              "z",
              "E(z)",
              "H_over_H0",
              "D_C_Mpc",
              "D_M_Mpc",
              "D_A_Mpc",
              "D_L_Mpc",
              "mu_mag",
              "dV_dz_dOmega_Mpc3"
            ].join(",")
          );

          for (let i = 0; i <= Nz; i++) {
            const z = i * dz;
            const Ez = E_z(z, Om0, Or0, Ol0);
            const dists = lcdmDistancesAtZ(
              H0,
              Om0,
              Or0,
              Ol0,
              z,
              600
            );
            const DC = dists.DC;
            const DM = dists.DM;
            const DA = dists.DA;
            const DL = dists.DL;
            const mu = 5 * Math.log10(DL) + 25;
            const dV = differentialVolume(
              H0,
              Om0,
              Or0,
              Ol0,
              z,
              DM,
              Ez
            );

            rows.push(
              [
                z.toFixed(6),
                Ez.toFixed(8),
                Ez.toFixed(8),
                DC.toFixed(8),
                DM.toFixed(8),
                DA.toFixed(8),
                DL.toFixed(8),
                mu.toFixed(8),
                dV.toExponential(8)
              ].join(",")
            );
          }

          const blob = new Blob([rows.join("\n")], {
            type: "text/csv"
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "lcdm_background_z_grid.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (err) {
          alert("CSV export error: " + err.message);
        }
      });
    }

    // ============================================================
    // PANEL 2: QKDE RUNNING K
    // ============================================================
    const qkdeComputeBtn = byId("qkde-compute");
    if (qkdeComputeBtn) {
      qkdeComputeBtn.addEventListener("click", () => {
        try {
          const z = parseFloat(byId("qkde-z").value);
          const K0 = parseFloat(byId("qkde-k0").value);
          const p = parseFloat(byId("qkde-p").value);

          if (!isFinite(z)) throw new Error("Invalid z.");
          if (!isFinite(K0)) throw new Error("Invalid K₀.");
          if (!isFinite(p)) throw new Error("Invalid p.");

          const a = 1 / (1 + z);
          const K = K_a(a, K0, p);
          const K_today = 1 + K0;

          const dlnK_dlnA = (-p * K0 * Math.pow(a, -p)) / K;

          setOutput(
            byId("qkde-output"),
`Scale factor a = ${a.toFixed(4)}
K(a)         = ${K.toFixed(6)}
K(0)         = ${K_today.toFixed(6)}
d ln K / d ln a (a) = ${dlnK_dlnA.toFixed(6)}`
          );
        } catch (err) {
          setOutput(byId("qkde-output"), err.message, true);
        }
      });
    }

    // QKDE presets
    (function attachQKDEPresets() {
      const buttons = document.querySelectorAll(
        "#qkde-card [data-qkde-preset]"
      );
      if (!buttons.length) return;

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          buttons.forEach((b) => b.classList.remove("is-active"));
          btn.classList.add("is-active");

          const preset = btn.dataset.qkdePreset;
          const K0Input = byId("qkde-k0");
          const pInput = byId("qkde-p");
          if (!K0Input || !pInput) return;

          if (preset === "mild") {
            K0Input.value = 0.5;
            pInput.value = 1.0;
          } else if (preset === "strong") {
            K0Input.value = 1.0;
            pInput.value = 3.0;
          }
        });
      });
    })();

    // ============================================================
    // PANEL 3: GR GROWTH AT ONE REDSHIFT
    // ============================================================
    const growComputeBtn = byId("grow-compute");
    if (growComputeBtn) {
      growComputeBtn.addEventListener("click", () => {
        try {
          const z = parseFloat(byId("lcdm-z").value);
          const Om = parseFloat(byId("grow-om0").value);
          const Or = parseFloat(byId("grow-or0").value);
          const Ol = parseFloat(byId("grow-ol0").value);

          const result = solveGrowthAtZ_LCDM(z, Om, Or, Ol);

          setOutput(
            byId("grow-output"),
`D(z) (normalized) = ${result.Dnorm.toFixed(6)}
f(z)               = ${result.f.toFixed(6)}`
          );
        } catch (err) {
          setOutput(byId("grow-output"), err.message, true);
        }
      });
    }

    // ============================================================
    // PANEL 4: ΛCDM vs QKDE SNAPSHOT (Option B-style consistency)
    // ============================================================
    const cmpComputeBtn = byId("cmp-compute");
    if (cmpComputeBtn) {
      cmpComputeBtn.addEventListener("click", () => {
        try {
          const z   = parseFloat(byId("cmp-z").value);
          const Om0 = parseFloat(byId("lcdm-om").value);
          const Or0 = parseFloat(byId("lcdm-or").value);
          const H0  = parseFloat(byId("lcdm-h0").value);
          const K0  = parseFloat(byId("cmp-k0").value);
          const p   = parseFloat(byId("cmp-p").value);

          if (!isFinite(z))  throw new Error("Invalid z.");
          if (!isFinite(H0) || H0 <= 0) throw new Error("H₀ must be positive.");
          if (!isFinite(Om0) || !isFinite(Or0))
            throw new Error("Invalid Ω parameters.");
          if (!isFinite(K0) || !isFinite(p))
            throw new Error("Invalid QKDE parameters.");

          const a = 1 / (1 + z);

          // ΛCDM snapshot: always flat here for comparison
          const Ol0_LCDM = 1 - Om0 - Or0;
          const E_LCDM   = E_z(z, Om0, Or0, Ol0_LCDM);
          const H_LCDM   = H0 * E_LCDM;

          // QKDE Option B background: ρ_DE(a)=ρ_DE0*K(1)/K(a)
          const ODE0     = 1 - Om0 - Or0;
          const K_today  = 1 + K0;
          const K_here   = K_a(a, K0, p);

          const E_QK     = Math.sqrt(
            Om0 * a**(-3) +
            Or0 * a**(-4) +
            ODE0 * (K_today / K_here)
          );
          const H_QK = H0 * E_QK;

          // GR growth (ΛCDM baseline)
          const gLCDM = solveGrowthAtZ_LCDM(z, Om0, Or0, Ol0_LCDM);

          setOutput(
            byId("cmp-output"),
`=== Snapshot @ z = ${z.toFixed(4)} ===

ΛCDM:
  H_LCDM(z)  = ${H_LCDM.toFixed(4)} km/s/Mpc
  D_LCDM(z)  = ${gLCDM.Dnorm.toFixed(6)}
  f_LCDM(z)  = ${gLCDM.f.toFixed(6)}

QKDE (ρ_DE ∝ K(1)/K(a)):
  K(a)       = ${K_here.toFixed(6)}
  K(1)       = ${K_today.toFixed(6)}
  H_QKDE(z)  = ${H_QK.toFixed(4)} km/s/Mpc
`
          );

        } catch (err) {
          setOutput(byId("cmp-output"), err.message, true);
        }
      });
    }

    // ============================================================
    // PANEL 5: ADVANCED GROWTH COMPARATOR
    // ============================================================
    let growthChart = null;

    const advComputeBtn = byId("adv-growth-compute");
    if (advComputeBtn) {
      advComputeBtn.addEventListener("click", () => {
        try {
          const Om0 = parseFloat(byId("adv-om0").value);
          const Or0 = parseFloat(byId("adv-or0").value);
          const zmax = parseFloat(byId("adv-zmax").value);
          const Npts = parseInt(byId("adv-samples").value, 10);

          const wQ  = parseFloat(byId("adv-wq").value);
          const w0  = parseFloat(byId("adv-w0").value);
          const wa  = parseFloat(byId("adv-wa").value);
          const K0q = parseFloat(byId("adv-k0q").value);
          const pq  = parseFloat(byId("adv-pq").value);

          const showLCDM = byId("adv-show-lcdm").checked;
          const showQ    = byId("adv-show-quint").checked;
          const showCPL  = byId("adv-show-kess").checked;
          const showQKDE = byId("adv-show-qkde").checked;

          const xMode = byId("adv-xaxis").value; // "a" or "z"
          const norm  = byId("adv-norm").value;  // "Da" or "Da_over_a"

          if (!(zmax > 0)) throw new Error("z_max must be > 0.");
          if (!(Npts >= 40)) throw new Error("Samples must be ≥ 40.");

          const ODE0 = 1 - Om0 - Or0; // flat for all models here
          if (ODE0 <= 0) {
            throw new Error(
              "Ω_DE,0 ≤ 0. Choose Ωₘ₀ + Ωᵣ₀ < 1 for the growth comparator."
            );
          }

          const a_min = 1 / (1 + zmax);
          const aArray = Array.from({ length: Npts }, (_, i) =>
            a_min + (1 - a_min) * (i / (Npts - 1))
          );

          const E_LCDM = (a) =>
            Math.sqrt(Om0 / a ** 3 + Or0 / a ** 4 + ODE0);

          const E_Quint = (a) =>
            Math.sqrt(
              Om0 / a ** 3 +
              Or0 / a ** 4 +
              ODE0 * a ** (-3 * (1 + wQ))
            );

          const E_CPL = (a) => {
            const ode =
              ODE0 *
              a ** (-3 * (1 + w0 + wa)) *
              Math.exp(-3 * wa * (1 - a));
            return Math.sqrt(
              Om0 / a ** 3 +
              Or0 / a ** 4 +
              ode
            );
          };

          const K_today = 1 + K0q;
          const E_QKDE = (a) => {
            const K = K_a(a, K0q, pq);
            return Math.sqrt(
              Om0 / a ** 3 +
              Or0 / a ** 4 +
              ODE0 * (K_today / K)
            );
          };

          function maybeNormalizeDa(Darr) {
            if (norm === "Da_over_a") {
              return Darr.map((D, i) => D / aArray[i]);
            }
            return Darr;
          }

          const datasets = [];

          if (showLCDM) {
            const D_L = maybeNormalizeDa(
              solveGrowthArray(aArray, E_LCDM, Om0)
            );
            datasets.push({
              label: "ΛCDM",
              data: D_L,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            });
          }

          if (showQ) {
            const D_Q = maybeNormalizeDa(
              solveGrowthArray(aArray, E_Quint, Om0)
            );
            datasets.push({
              label: "Quintessence (w)",
              data: D_Q,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            });
          }

          if (showCPL) {
            const D_C = maybeNormalizeDa(
              solveGrowthArray(aArray, E_CPL, Om0)
            );
            datasets.push({
              label: "CPL",
              data: D_C,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            });
          }

          if (showQKDE) {
            const D_QK = maybeNormalizeDa(
              solveGrowthArray(aArray, E_QKDE, Om0)
            );
            datasets.push({
              label: "QKDE (ρ∝K(1)/K(a))",
              data: D_QK,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            });
          }

          const xLabels =
            xMode === "z"
              ? aArray.map((a) => (1 / a - 1).toFixed(3))
              : aArray.map((a) => a.toFixed(3));

          const xTitle =
            xMode === "z" ? "Redshift z" : "Scale factor a";
          const yTitle =
            norm === "Da_over_a"
              ? "D(a)/a (normalized)"
              : "D(a) (D(1)=1)";

          const advCanvas = byId("adv-growth-canvas");
          if (!advCanvas) return;
          const ctx = advCanvas.getContext("2d");
          if (growthChart) growthChart.destroy();

          growthChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: xLabels,
              datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  title: { display: true, text: xTitle }
                },
                y: {
                  title: { display: true, text: yTitle }
                }
              },
              plugins: {
                legend: { display: true }
              }
            }
          });

          setOutput(
            byId("adv-growth-info"),
`Plotted:
${showLCDM ? "• ΛCDM\n" : ""}${
              showQ ? "• Quintessence (constant w)\n" : ""
            }${showCPL ? "• CPL w(a)\n" : ""}${
              showQKDE ? "• QKDE (ρ∝K(1)/K(a))\n" : ""
            }`
          );
        } catch (err) {
          setOutput(byId("adv-growth-info"), err.message, true);
        }
      });
    }

    // ------------------------------------------------------------
    // PANEL 5: ADVANCED GROWTH — CSV EXPORT (robust)
    // ------------------------------------------------------------
    const advExportBtn = byId("adv-export-csv");
    if (advExportBtn) {
      advExportBtn.addEventListener("click", () => {
        try {
          // ---------------------------------------
          // Read inputs
          // ---------------------------------------
          const Om0 = parseFloat(byId("adv-om0").value);
          const Or0 = parseFloat(byId("adv-or0").value);
          const zmax = parseFloat(byId("adv-zmax").value);
          const Npts = parseInt(byId("adv-samples").value, 10);

          const wQ = parseFloat(byId("adv-wq").value);
          const w0 = parseFloat(byId("adv-w0").value);
          const wa = parseFloat(byId("adv-wa").value);

          const K0q = parseFloat(byId("adv-k0q").value);
          const pq  = parseFloat(byId("adv-pq").value);

          const showLCDM = byId("adv-show-lcdm").checked;
          const showQ    = byId("adv-show-quint").checked;
          const showCPL  = byId("adv-show-kess").checked;
          const showQKDE = byId("adv-show-qkde").checked;

          const xMode = byId("adv-xaxis").value; // "a" or "z"
          const norm  = byId("adv-norm").value;  // "Da" or "Da_over_a"

          // ---------------------------------------
          // Validation
          // ---------------------------------------
          if (!(zmax > 0)) throw new Error("z_max must be > 0.");
          if (!(Npts >= 40)) throw new Error("Samples must be ≥ 40.");

          const ODE0 = 1 - Om0 - Or0;
          if (ODE0 <= 0) throw new Error("Ω_DE,0 must be positive.");

          // ---------------------------------------
          // Build scale-factor grid
          // ---------------------------------------
          const a_min = 1 / (1 + zmax);
          const aArray = Array.from({ length: Npts }, (_, i) =>
            a_min + (1 - a_min) * (i / (Npts - 1))
          );

          // ---------------------------------------
          // Background E(a)
          // ---------------------------------------
          const E_LCDM = (a) => Math.sqrt(Om0/a**3 + Or0/a**4 + ODE0);

          const E_Quint = (a) =>
            Math.sqrt(Om0/a**3 + Or0/a**4 + ODE0 * a**(-3*(1 + wQ)));

          const E_CPL = (a) => {
            const ode = ODE0 * a**(-3*(1+w0+wa)) * Math.exp(-3*wa*(1 - a));
            return Math.sqrt(Om0/a**3 + Or0/a**4 + ode);
          };

          const K_today = 1 + K0q;
          const E_QKDE = (a) => {
            const K = K_a(a, K0q, pq);
            return Math.sqrt(Om0/a**3 + Or0/a**4 + ODE0 * (K_today / K));
          };

          // ---------------------------------------
          // Additional physics
          // ---------------------------------------
          const Omega_m = (a, E) => (Om0 / a**3) / (E*E);

          const w_eff_QKDE = (a) => {
            const K = K_a(a, K0q, pq);
            const dlnK_dlnA = (-pq * K0q * a**(-pq)) / K;
            return -1 - (1/3) * dlnK_dlnA;
          };

          const normalize = (Darr) =>
            norm === "Da_over_a" ? Darr.map((D,i) => D / aArray[i]) : Darr;

          // ---------------------------------------
          // Compute growth arrays
          // ---------------------------------------
          const models = [];

          if (showLCDM) {
            models.push({
              name: "LCDM",
              E: E_LCDM,
              growth: normalize(solveGrowthArray(aArray, E_LCDM, Om0))
            });
          }
          if (showQ) {
            models.push({
              name: "Quintessence",
              E: E_Quint,
              growth: normalize(solveGrowthArray(aArray, E_Quint, Om0))
            });
          }
          if (showCPL) {
            models.push({
              name: "CPL",
              E: E_CPL,
              growth: normalize(solveGrowthArray(aArray, E_CPL, Om0))
            });
          }
          if (showQKDE) {
            models.push({
              name: "QKDE",
              E: E_QKDE,
              growth: normalize(solveGrowthArray(aArray, E_QKDE, Om0)),
              w_eff: w_eff_QKDE
            });
          }

          // ------------------------------------------------------------
          // CSV metadata block
          // ------------------------------------------------------------
          const rows = [];
          rows.push("# QKDE Cosmology Tools – Growth Comparator Export");
          rows.push(`# Generated: ${new Date().toISOString()}`);
          rows.push(`# Om0 = ${Om0}, Or0 = ${Or0}, ODE0 = ${ODE0}`);
          rows.push(`# Quintessence w = ${wQ}`);
          rows.push(`# CPL w0 = ${w0}, wa = ${wa}`);
          rows.push(`# QKDE K0 = ${K0q}, p = ${pq}`);
          rows.push(`# x-axis = ${xMode}, normalization = ${norm}`);
          rows.push("");

          // ------------------------------------------------------------
          // CSV header
          // ------------------------------------------------------------
          const header = [
            "index",
            xMode,
            ...models.map(m => `${m.name}_D(a)`),
            ...models.map(m => `${m.name}_E(a)`),
            ...models.map(m => `${m.name}_Omega_m(a)`)
          ];

          if (showQKDE) header.push("QKDE_w_eff(a)");

          rows.push(header.join(","));

          // ------------------------------------------------------------
          // Data rows
          // ------------------------------------------------------------
          for (let i = 0; i < Npts; i++) {
            const a = aArray[i];
            const xval = xMode === "z" ? (1/a - 1) : a;

            const row = [
              i,
              xval.toPrecision(10),
              ...models.map(m => m.growth[i].toPrecision(10)),
              ...models.map(m => m.E(a).toPrecision(10)),
              ...models.map(m => Omega_m(a, m.E(a)).toPrecision(10))
            ];

            if (showQKDE) {
              row.push(w_eff_QKDE(a).toPrecision(10));
            }

            rows.push(row.join(","));
          }

          // ------------------------------------------------------------
          // Export CSV
          // ------------------------------------------------------------
          const blob = new Blob([rows.join("\n")], { type: "text/csv" });
          const url = URL.createObjectURL(blob);

          const aTag = document.createElement("a");
          aTag.href = url;
          aTag.download = "qkde_growth_comparator_full.csv";
          document.body.appendChild(aTag);
          aTag.click();
          document.body.removeChild(aTag);

          URL.revokeObjectURL(url);

        } catch (err) {
          alert("CSV export error: " + err.message);
        }
      });
    }
  });
})();
</script>
