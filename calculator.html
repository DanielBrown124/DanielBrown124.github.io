<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8" />
<title>QKDE Cosmology Tools – Interactive Calculator Suite</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ================= MATHJAX ================= -->
<script>
  window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- ================= CHART.JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg-body: #020713;
  --bg-page: rgba(12,18,28,0.9);
  --bg-card: rgba(12,18,28,0.82);
  --bg-card-wide: rgba(12,18,28,0.88);
  --bg-input: rgba(5,10,18,0.9);
  --bg-output: rgba(0,0,0,0.55);
  --bg-formula: rgba(8,12,20,0.95);

  --border-card: rgba(102,252,241,0.14);
  --border-card-wide: rgba(102,252,241,0.18);
  --border-input: rgba(120,160,190,0.7);
  --border-output: rgba(120,160,190,0.36);
  --border-formula: rgba(120,160,190,0.45);

  --text-main: #e8e9ef;
  --text-muted: #c0d6f5;
  --text-accent: #66fcf1;
  --text-heading: #bfe9ff;
  --text-heading-strong: #d6f7ff;

  --chip-bg: rgba(8,14,22,0.95);
  --chip-border: rgba(160,220,255,0.5);
  --chip-bg-active1: #66fcf1;
  --chip-bg-active2: #45b9d9;
  --chip-text-active: #031016;

  --btn-bg1: #d2f2ff;
  --btn-bg2: #bfe6f7;
  --btn-border: rgba(200,240,255,0.8);

  --shadow-card: 0 0 35px rgba(102,252,241,0.15);
  --shadow-inner: inset 0 0 18px rgba(102,252,241,0.06);

  --error-bg: rgba(70,0,10,0.7);
  --error-text: #ffe6e6;

  --link-color: #66fcf1;
}

/* Light theme overrides */
:root[data-theme="light"] {
  --bg-body: #f6f7fb;
  --bg-page: #ffffff;
  --bg-card: #f9fbff;
  --bg-card-wide: #f9fbff;
  --bg-input: #ffffff;
  --bg-output: #f2f4fb;
  --bg-formula: #f5f7ff;

  --border-card: rgba(20,60,120,0.10);
  --border-card-wide: rgba(20,60,120,0.18);
  --border-input: rgba(120,160,190,0.7);
  --border-output: rgba(120,160,190,0.36);
  --border-formula: rgba(120,160,190,0.45);

  --text-main: #1b2540;
  --text-muted: #4b5a7a;
  --text-accent: #0077aa;
  --text-heading: #133a67;
  --text-heading-strong: #0f2b4b;

  --chip-bg: #ffffff;
  --chip-border: rgba(30,80,140,0.4);
  --chip-bg-active1: #0f9bdc;
  --chip-bg-active2: #16c3c6;
  --chip-text-active: #ffffff;

  --btn-bg1: #0f9bdc;
  --btn-bg2: #16c3c6;
  --btn-border: rgba(0,120,190,0.8);

  --shadow-card: 0 10px 24px rgba(15, 50, 90, 0.15);
  --shadow-inner: inset 0 0 0 rgba(0,0,0,0);

  --error-bg: rgba(220,40,40,0.12);
  --error-text: #7a0012;

  --link-color: #0f9bdc;
}

/* ---- Global background + typography ---- */
body {
  background: var(--bg-body);
  margin: 0;
  padding: 0;
  color: var(--text-main);
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  line-height: 1.6;
}

/* ================= HEADER ================= */
.site-header {
  max-width: 1100px;
  margin: 16px auto 0;
  padding: 10px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.site-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.site-header a {
  color: var(--link-color);
  font-size: 0.9rem;
  text-decoration: none;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid rgba(102,252,241,0.3);
}

:root[data-theme="light"] .site-header a {
  border-color: rgba(0,120,190,0.35);
}

.site-header a:hover {
  background: rgba(102,252,241,0.15);
}

:root[data-theme="light"] .site-header a:hover {
  background: rgba(15,155,220,0.08);
}

/* Theme toggle button */
.theme-toggle {
  border-radius: 999px;
  border: 1px solid rgba(102,252,241,0.3);
  background: transparent;
  color: var(--text-main);
  font-size: 0.85rem;
  padding: 6px 14px;
  cursor: pointer;
}
.theme-toggle:hover {
  background: rgba(102,252,241,0.14);
}

:root[data-theme="light"] .theme-toggle {
  border-color: rgba(0,120,190,0.35);
}
:root[data-theme="light"] .theme-toggle:hover {
  background: rgba(15,155,220,0.08);
}

/* ================= MAIN PAGE WRAPPER ================= */
.page {
  max-width: 1100px;
  margin: 8px auto 32px;
  padding: 28px 24px 32px;
  background: var(--bg-page);
  border-radius: 18px;
  border: 1px solid var(--border-card);
  box-shadow: var(--shadow-card);
  backdrop-filter: blur(10px);
}

/* ---- Header ---- */
h1 {
  text-align: center;
  font-family: "Merriweather", Georgia, serif;
  font-weight: 300;
  font-size: 2rem;
  color: var(--text-heading);
  margin-bottom: 6px;
}
h2, h3, h4 {
  font-family: "Merriweather", Georgia, serif;
  font-weight: 300;
  color: var(--text-heading);
}

.center { text-align: center; }

.calc-intro {
  font-size: 0.95rem;
  opacity: 0.95;
  margin-bottom: 18px;
  max-width: 860px;
  margin-left: auto;
  margin-right: auto;
  color: var(--text-muted);
}

/* ============================================================
   GRID / CARD LAYOUT
============================================================ */
.calc-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 22px;
  justify-content: center;
  margin-top: 14px;
}

/* Collapsible panels wrapper */
.calc-panel {
  width: 100%;
  margin-bottom: 10px;
}

/* Panel header with title + toggle */
.calc-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.calc-panel-title {
  font-size: 0.95rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-heading-strong);
}

.panel-toggle-btn {
  font-size: 0.78rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(120,160,190,0.7);
  background: transparent;
  color: var(--text-main);
  cursor: pointer;
}
.panel-toggle-btn:hover {
  background: rgba(102,252,241,0.12);
}

/* Panel body collapsible */
.calc-panel-body {
  transition: max-height 0.3s ease, opacity 0.3s ease;
  overflow: hidden;
}

.calc-panel.collapsed .calc-panel-body {
  max-height: 0;
  opacity: 0;
  pointer-events: none;
}

/* A generous default max-height so content fits before collapse */
.calc-panel:not(.collapsed) .calc-panel-body {
  max-height: 2000px;
  opacity: 1;
}

/* Calculator card itself */
.calc-card {
  flex: 1 1 260px;
  max-width: 100%;
  background: radial-gradient(circle at 0% 0%, rgba(102,252,241,0.12) 0, transparent 55%),
              radial-gradient(circle at 120% 120%, rgba(102,252,241,0.10) 0, transparent 55%),
              var(--bg-card);
  padding: 18px 20px 20px;
  border-radius: 16px;
  border: 1px solid var(--border-card);
  box-shadow: 0 0 22px rgba(102,252,241,0.12), var(--shadow-inner);
  transition: 0.25s ease;
  position: relative;
  overflow: hidden;
}
.calc-card::before {
  content: "";
  position: absolute;
  top: 0; left: 0;
  height: 3px;
  width: 100%;
  background: linear-gradient(
    to right,
    rgba(102,252,241,0.85),
    rgba(79,160,201,0.6),
    rgba(102,252,241,0.85)
  );
}
.calc-card:hover {
  border-color: rgba(102,252,241,0.28);
  transform: translateY(-2px);
}

/* Header row inside cards */
.calc-header-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 8px 12px;
  margin-bottom: 8px;
}

.calc-header-row h3 {
  margin: 0;
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--text-heading-strong);
}

/* Misc text */
.calc-note {
  font-size: 0.85rem;
  opacity: 0.9;
  margin-bottom: 10px;
}

/* ============================================================
   INPUTS + LABELS
============================================================ */
.calc-input-row {
  display: grid;
  gap: 8px 10px;
  grid-template-columns: 1fr 1fr;
}
@media (max-width: 700px) {
  .calc-input-row {
    grid-template-columns: 1fr;
  }
}

.calc-label {
  display: block;
  margin-bottom: 3px;
  font-size: 0.82rem;
  text-transform: uppercase;
  color: var(--text-heading);
  letter-spacing: 0.05em;
}

.calc-input {
  width: 100%;
  padding: 7px 10px;
  border-radius: 7px;
  border: 1px solid var(--border-input);
  background: var(--bg-input);
  color: var(--text-main);
  font-size: 0.9rem;
  box-sizing: border-box;
}
.calc-input:focus {
  outline: none;
  border-color: var(--text-accent);
}

/* Select shares style */
select.calc-input {
  padding-right: 26px;
}

/* ============================================================
   BUTTONS
============================================================ */
.calc-action-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 14px;
}

.calc-btn {
  background: linear-gradient(135deg, var(--btn-bg1), var(--btn-bg2));
  border: 1px solid var(--btn-border);
  border-radius: 999px;
  color: #031016;
  cursor: pointer;
  font-size: 0.86rem;
  font-weight: 500;
  letter-spacing: 0.04em;
  padding: 8px 16px;
  text-transform: uppercase;
  transition: transform 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
}
.calc-btn:hover {
  background: linear-gradient(135deg, #e6f6ff, #d7f0ff);
  box-shadow: 0 0 12px rgba(210,240,255,0.75);
  transform: translateY(-1px);
}
.calc-btn.secondary {
  background: transparent;
  border-color: rgba(140,200,255,0.7);
  color: var(--text-main);
}
.calc-btn.secondary:hover {
  background: rgba(10,20,32,0.9);
  color: #c8f3ff;
}

/* ============================================================
   OUTPUT BOXES
============================================================ */
.calc-output,
.calc-output-mini {
  margin-top: 12px;
  background: var(--bg-output);
  border: 1px solid var(--border-output);
  border-radius: 10px;
  padding: 10px;
  font-family: "JetBrains Mono", Menlo, Consolas, monospace;
  font-size: 0.8rem;
  white-space: pre-wrap;
  overflow-y: auto;
  max-height: 210px;
}
.calc-output-mini {
  max-height: 150px;
}

.calc-output.error {
  background: var(--error-bg);
  color: var(--error-text);
}

/* ============================================================
   FORMULA BOXES
============================================================ */
.calc-formula-box {
  margin-top: 10px;
  background: var(--bg-formula);
  border: 1px solid var(--border-formula);
  border-radius: 8px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
  padding: 0 10px;
  opacity: 0;
}
.calc-formula-box.is-open {
  max-height: 260px;
  padding: 10px;
  opacity: 1;
}
.calc-formula-inner {
  overflow-x: auto;
}

/* ============================================================
   PRESET PILLS
============================================================ */
.calc-pill-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.calc-pill {
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid var(--chip-border);
  font-size: 0.72rem;
  text-transform: uppercase;
  cursor: pointer;
  background: var(--chip-bg);
  color: var(--text-muted);
}
.calc-pill:hover {
  background: rgba(65,190,220,0.2);
}
.calc-pill.is-active {
  background: linear-gradient(135deg, var(--chip-bg-active1), var(--chip-bg-active2));
  color: var(--chip-text-active);
  border-color: rgba(200,240,255,0.9);
}

/* ============================================================
   ADVANCED FULL-WIDTH COMPARATOR
============================================================ */
.calc-card-wide {
  width: 100%;
  max-width: 100%;
  margin-top: 32px;
  background: radial-gradient(circle at 0% 50%, rgba(102,252,241,0.10) 0, transparent 70%),
              radial-gradient(circle at 100% 50%, rgba(102,252,241,0.08) 0, transparent 70%),
              var(--bg-card-wide);
  border-radius: 18px;
  border: 1px solid var(--border-card-wide);
  box-shadow:
      0 0 26px rgba(102,252,241,0.16),
      inset 0 0 22px rgba(102,252,241,0.06);
  padding: 28px 24px 32px;
  position: relative;
}

.calc-card-wide h3 {
  margin-top: 0;
  font-size: 1.05rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--text-heading-strong);
  margin-bottom: 10px;
}

.calc-card-wide canvas {
  width: 100%;
  height: 420px;
  max-height: 420px;
  margin-top: 16px;
  border-radius: 10px;
  background: rgba(0,0,0,0.25);
  padding: 8px;
  box-shadow:
      0 0 14px rgba(102,252,241,0.10),
      inset 0 0 12px rgba(102,252,241,0.05);
}

/* Info box under plot */
#adv-growth-info {
  margin-top: 16px;
}

/* Footnote */
.calc-footnote {
  font-size: 0.85rem;
  opacity: 0.9;
  margin-top: 20px;
  color: var(--text-muted);
}
</style>
</head>

<body id="top">

<!-- ============================================================
     GLOBAL HEADER
============================================================ -->
<header class="site-header" role="banner">
  <div class="site-header-left">
    <a href="index.html" title="Return to main page">← Back to Home</a>
    <a href="#top" title="Scroll to top of page">Top</a>
  </div>

  <!-- Theme toggle describes the mode you will switch TO -->
  <button id="theme-toggle" class="theme-toggle" type="button"
          aria-label="Toggle light/dark mode">
    Light mode
  </button>
</header>

<div class="page" role="main">

  <!-- ============================================================
       PAGE TITLE + INTRO
  ============================================================ -->
  <h1>QKDE Interactive Calculator Suite</h1>
  <p class="center" style="opacity:0.9;">
    ΛCDM • QKDE • Growth • Distances • EFT-consistent backgrounds
  </p>

  <p class="calc-intro">
    This suite implements <strong>exact General Relativistic background and linear-growth
    equations</strong> for ΛCDM, constant-\(w\) quintessence, CPL \(w(a)\) parameterizations,
    and the QKDE kinetic-drift model. It is designed as a research-oriented,
    referee-grade environment for comparing:
    <em>H(a)</em>, comoving distances, luminosity distances, lookback times,
    density fractions, and linear growth \(D(a)\).
  </p>

  <p class="calc-intro">
    Every equation used is derived directly from GR+FLRW or EFT-consistent scalar-field
    backgrounds. No fitting templates or phenomenological approximations are introduced
    beyond explicit parameterizations you choose.
  </p>

  <!-- ============================================================
       PANEL 1 — ΛCDM BACKGROUND DASHBOARD (ADVANCED)
  ============================================================ -->
  <section class="calc-panel" id="panel-lcdm" aria-labelledby="lcdm-title">
    <div class="calc-panel-header">
      <div class="calc-panel-title" id="lcdm-title">ΛCDM background + distances</div>
      <button class="panel-toggle-btn" data-panel="panel-lcdm"
              aria-expanded="true" aria-controls="panel-lcdm-body">Hide</button>
    </div>

    <div class="calc-panel-body" id="panel-lcdm-body">
      <article class="calc-card" id="lcdm-card">

        <!-- Header with presets -->
        <div class="calc-header-row">
          <h3>ΛCDM Background &amp; Distances</h3>
          <div class="calc-pill-row" role="group" aria-label="ΛCDM presets">
            <button class="calc-pill is-active" data-lcdm-preset="planck"
                    title="Planck 2018 TT+TE+EE baseline">Planck 2018</button>
            <button class="calc-pill" data-lcdm-preset="local"
                    title="Local SH0ES-like measurement">Local H₀</button>
            <button class="calc-pill" data-lcdm-preset="wmap"
                    title="WMAP9 cosmology">WMAP-like</button>
          </div>
        </div>

        <!-- Description -->
        <h4>ΛCDM with optional curvature (exact GR equations)</h4>
        <p class="calc-note">
          Computes the full GR background expansion for your chosen ΛCDM parameters.
          Curvature is included through the derived parameter
          \(\Omega_{k0}=1-\Omega_{m0}-\Omega_{r0}-\Omega_{\Lambda0}\) when flatness
          is not enforced.
          From these inputs, the calculator outputs:
        </p>

        <ul class="calc-note" style="margin-top:-8px;">
          <li>Expansion rate \(E(z)\), \(H(z)\)</li>
          <li>All FLRW distance measures: \(D_C\), \(D_M\), \(D_A\), \(D_L\)</li>
          <li>SN modulus \(\mu(z)\)</li>
          <li>Redshift-dependent density fractions \(\Omega_i(z)\)</li>
          <li>Lookback time \(t_L(z)\), cosmic age \(t_0\)</li>
          <li>BAO distance \(D_V(z)\)</li>
          <li>Differential comoving volume \(dV/dz\,d\Omega\)</li>
        </ul>

        <!-- Input row 1 -->
        <div class="calc-input-row">
          <div>
            <label class="calc-label">Evaluation redshift z</label>
            <input id="lcdm-z" class="calc-input" type="number"
                   value="0.5" step="0.01" min="0" aria-label="Evaluation redshift">
          </div>

          <div>
            <label class="calc-label">H₀ [km/s/Mpc]</label>
            <input id="lcdm-h0" class="calc-input" type="number"
                   value="67.4" step="0.1" min="10" aria-label="H0 today">
          </div>

          <div>
            <label class="calc-label">Ωₘ₀</label>
            <input id="lcdm-om" class="calc-input" type="number"
                   value="0.315" step="0.001" min="0" max="2">
          </div>

          <div>
            <label class="calc-label">Ωᵣ₀</label>
            <input id="lcdm-or" class="calc-input" type="number"
                   value="5e-5" step="1e-5" min="0" max="0.01">
          </div>

          <div>
            <label class="calc-label">ΩΛ₀</label>
            <input id="lcdm-ol" class="calc-input" type="number"
                   value="0.68495" step="0.0001" min="0" max="2">
          </div>

          <div>
            <label class="calc-label">z-steps (integration)</label>
            <input id="lcdm-steps" class="calc-input" type="number"
                   value="600" step="100" min="200"
                   title="Higher values improve accuracy of χ(z) and t(z) integrals">
          </div>
        </div>

        <!-- Input row 2 -->
        <div class="calc-input-row" style="margin-top:6px;">

          <div>
            <label class="calc-label">Flatness</label>
            <label style="font-size:0.8rem; opacity:0.9;">
              <input type="checkbox" id="lcdm-flat" checked>
              Enforce Ωₘ₀ + Ωᵣ₀ + ΩΛ₀ = 1
            </label>
          </div>

          <div>
            <label class="calc-label">Standard radiation</label>
            <label style="font-size:0.8rem; opacity:0.9;">
              <input type="checkbox" id="lcdm-auto-rad" checked>
              Use standard \(T_{\rm CMB}=2.7255\,{\rm K}\), \(N_{\rm eff}=3.046\)
            </label>
          </div>

          <div>
            <label class="calc-label">Derived Ωₖ₀</label>
            <input id="lcdm-ok" class="calc-input" type="text"
                   value="0" disabled aria-readonly="true">
          </div>

          <div>
            <label class="calc-label">Plot range z<sub>max</sub></label>
            <input id="lcdm-zmax-plot" class="calc-input" type="number"
                   value="3" step="0.5" min="0.1">
          </div>
        </div>

        <!-- Plot quantity selector -->
        <div class="calc-input-row" style="margin-top:6px;">
          <div>
            <label class="calc-label">Quantity to plot</label>
            <select id="lcdm-plot-y" class="calc-input"
                    aria-label="Select diagnostic quantity to plot">
              <option value="E">E(z)</option>
              <option value="H">H(z)/H₀</option>
              <option value="DC">D_C(z) [Mpc]</option>
              <option value="DM">D_M(z) [Mpc]</option>
              <option value="DA">D_A(z) [Mpc]</option>
              <option value="DL">D_L(z) [Mpc]</option>
            </select>
          </div>

          <div>
            <label class="calc-label">Export grid</label>
            <p style="font-size:0.78rem; margin:0; opacity:0.9;">
              Download a CSV table of z vs. distances for pipelines or external codes.
            </p>
          </div>
        </div>

        <!-- Action buttons -->
        <div class="calc-action-row">
          <button class="calc-btn" id="lcdm-compute" type="button">Compute ΛCDM</button>
          <button class="calc-btn secondary" id="lcdm-export-csv" type="button">Export CSV</button>
          <button class="calc-btn secondary" id="lcdm-formula-toggle" type="button">Show formulas</button>
        </div>

        <!-- Output + plot -->
        <pre id="lcdm-output" class="calc-output" aria-live="polite"></pre>
        <canvas id="lcdm-canvas" style="margin-top:12px; max-height:260px;"></canvas>

        <!-- Formula box -->
        <div id="lcdm-formulas" class="calc-formula-box" aria-hidden="true">
          <div class="calc-formula-inner">
            <!-- unchanged formulas... -->
          </div>
        </div>
      </article>
    </div>
  </section>

  <!-- ============================================================
       PANEL 2 — QKDE RUNNING K
  ============================================================ -->
  <section class="calc-panel" id="panel-qkde" aria-labelledby="qkde-title">
    <div class="calc-panel-header">
      <div class="calc-panel-title" id="qkde-title">QKDE running kinetic normalization</div>
      <button class="panel-toggle-btn" data-panel="panel-qkde"
              aria-expanded="true" aria-controls="panel-qkde-body">Hide</button>
    </div>

    <div class="calc-panel-body" id="panel-qkde-body">
      <article class="calc-card" id="qkde-card">
        <div class="calc-header-row">
          <h3>QKDE Running K</h3>
          <div class="calc-pill-row" role="group" aria-label="QKDE drift presets">
            <button class="calc-pill is-active" data-qkde-preset="mild">Mild drift</button>
            <button class="calc-pill" data-qkde-preset="strong">Strong drift</button>
          </div>
        </div>

        <h4>Background kinetic drift (EFT-consistent)</h4>
        <p class="calc-note">
          Implements a running kinetic normalization
          \(K(N)=1+K_0 e^{-pN}\) with \(N=\ln a\).
          This produces a purely background-level drift in the kinetic operator
          while leaving gravitational dynamics (and perturbations) exactly GR.
        </p>

        <div class="calc-input-row">
          <div>
            <label class="calc-label">Redshift z</label>
            <input id="qkde-z" class="calc-input" type="number"
                   step="0.01" value="0.5">
          </div>

          <div>
            <label class="calc-label">K₀</label>
            <input id="qkde-k0" class="calc-input" type="number"
                   step="0.05" value="0.5">
          </div>

          <div>
            <label class="calc-label">p</label>
            <input id="qkde-p" class="calc-input" type="number"
                   step="0.1" value="1.0">
          </div>

          <div>
            <label class="calc-label">K(0) reference</label>
            <input id="qkde-kref" class="calc-input" type="number"
                   step="0.01" value="1.0">
          </div>
        </div>

        <div class="calc-action-row">
          <button class="calc-btn" id="qkde-compute">Compute K(z)</button>
          <button class="calc-btn secondary" id="qkde-formula-toggle">Show definitions</button>
        </div>

        <pre id="qkde-output" class="calc-output" aria-live="polite"></pre>

        <div id="qkde-formulas" class="calc-formula-box" aria-hidden="true">
          <div class="calc-formula-inner">
            <!-- unchanged formulas -->
          </div>
        </div>
      </article>
    </div>
  </section>

  <!-- ============================================================
       PANEL 3 — GROWTH AT ONE REDSHIFT
  ============================================================ -->
  <section class="calc-panel" id="panel-growth" aria-labelledby="growth-title">
    <div class="calc-panel-header">
      <div class="calc-panel-title" id="growth-title">GR linear growth factor</div>
      <button class="panel-toggle-btn" data-panel="panel-growth">Hide</button>
    </div>

    <div class="calc-panel-body">
      <article class="calc-card" id="growth-card">

        <div class="calc-header-row">
          <h3>GR Growth D(a)</h3>
          <span class="calc-pill is-active" style="cursor:default;"
                aria-label="Growth always solved using GR only">GR Only</span>
        </div>

        <h4>Linear growth on the ΛCDM background</h4>
        <p class="calc-note">
          Solves the exact GR equation  
          \( D'' + (2+H'/H)D' - \tfrac32 \Omega_m(a) D = 0 \)  
          using the ΛCDM parameters from Panel 1.
          Growth is normalized so that \(D(1)=1\).
        </p>

        <div class="calc-input-row">
          <div>
            <label class="calc-label">Ωₘ₀</label>
            <input id="grow-om0" class="calc-input" type="number"
                   value="0.3" step="0.001">
          </div>

          <div>
            <label class="calc-label">Ωᵣ₀</label>
            <input id="grow-or0" class="calc-input" type="number"
                   value="0" step="1e-5">
          </div>

          <div>
            <label class="calc-label">ΩΛ₀</label>
            <input id="grow-ol0" class="calc-input" type="number"
                   value="0.7" step="0.001">
          </div>

          <div>
            <label class="calc-label">Evaluation z</label>
            <input class="calc-input" value="Uses ΛCDM z" disabled>
          </div>
        </div>

        <div class="calc-action-row">
          <button class="calc-btn" id="grow-compute">Compute D(z)</button>
          <button class="calc-btn secondary" id="grow-formula-toggle">Show equation</button>
        </div>

        <pre id="grow-output" class="calc-output-mini" aria-live="polite"></pre>

        <div id="grow-formulas" class="calc-formula-box">
          <div class="calc-formula-inner">
            <!-- unchanged -->
          </div>
        </div>

      </article>
    </div>
  </section>

  <!-- ============================================================
       PANEL 4 — SNAPSHOT ΛCDM vs QKDE
  ============================================================ -->
  <section class="calc-panel" id="panel-compare" aria-labelledby="compare-title">
    <div class="calc-panel-header">
      <div class="calc-panel-title" id="compare-title">ΛCDM vs QKDE snapshot</div>
      <button class="panel-toggle-btn" data-panel="panel-compare">Hide</button>
    </div>

    <div class="calc-panel-body">
      <article class="calc-card">

        <div class="calc-header-row">
          <h3>ΛCDM vs QKDE</h3>
          <div class="calc-pill-row">
            <span class="calc-pill is-active" style="cursor:default;"
                  aria-label="Snapshot comparison mode">Snapshot</span>
          </div>
        </div>

        <h4>Evaluate both at one redshift</h4>
        <p class="calc-note">
          Computes \(H(z)\), growth \(D(z)\), and QKDE’s kinetic drift \(K(a)\) at a
          single redshift using ΛCDM parameters from Panel 1 and QKDE parameters below.
        </p>

        <div class="calc-input-row">
          <div>
            <label class="calc-label">Redshift z</label>
            <input id="cmp-z" class="calc-input" type="number"
                   step="0.01" value="0.5">
          </div>

          <div>
            <label class="calc-label">K₀</label>
            <input id="cmp-k0" class="calc-input" type="number"
                   step="0.05" value="0.5">
          </div>

          <div>
            <label class="calc-label">p</label>
            <input id="cmp-p" class="calc-input" type="number"
                   step="0.1" value="1.0">
          </div>

          <div>
            <label class="calc-label">K(0) reference</label>
            <input id="cmp-kref" class="calc-input" type="number"
                   step="0.01" value="1.0">
          </div>
        </div>

        <div class="calc-action-row">
          <button class="calc-btn" id="cmp-compute">Compare at z</button>
        </div>

        <pre id="cmp-output" class="calc-output-mini" aria-live="polite"></pre>

      </article>
    </div>
  </section>

  <!-- ============================================================
       PANEL 5 — ADVANCED COMPARATOR (GROWTH)
  ============================================================ -->
  <section class="calc-panel" id="panel-advanced" aria-labelledby="advanced-title">
    <div class="calc-panel-header">
      <div class="calc-panel-title" id="advanced-title">
        Growth comparator: ΛCDM vs quintessence vs CPL vs QKDE
      </div>
      <button class="panel-toggle-btn" data-panel="panel-advanced">Hide</button>
    </div>

    <div class="calc-panel-body">
      <article class="calc-card-wide" id="advanced-growth-card">

        <h3>Growth Comparator (multiple backgrounds)</h3>
        <p class="calc-note">
          Solves the exact GR growth equation on four selectable backgrounds:
          ΛCDM, constant-\(w\) quintessence, CPL \(w(a)=w_0+w_a(1-a)\), and the
          QKDE kinetic-drift background
          \(\rho_{\rm DE}(a) \propto K(1)/K(a)\).  
          All growth curves are normalized to \(D(1)=1\).
        </p>

        <!-- input rows unchanged except for improved labels -->
        <!-- ... (You already have full content; leaving it unchanged) -->

      </article>
    </div>
  </section>

</div><!-- /page -->
</body>

<!-- ================= JS (wrapped in DOMContentLoaded) ================= -->
<script>
  // qkde-tools.js

(function () {
  "use strict";

  // ============================================================
  // BASIC DOM HELPERS
  // ============================================================
  function byId(id) {
    return document.getElementById(id);
  }

  function setOutput(el, text, isError = false) {
    if (!el) return;
    el.textContent = text;
    if (isError) {
      el.classList.add("error");
    } else {
      el.classList.remove("error");
    }
  }

  function attachFormulaToggle(btnId, boxId) {
    const btn = byId(btnId);
    const box = byId(boxId);
    if (!btn || !box) return;

    btn.addEventListener("click", () => {
      const open = box.classList.toggle("is-open");
      box.setAttribute("aria-hidden", open ? "false" : "true");

      if (btn.dataset.altLabelOpen && btn.dataset.altLabelClosed) {
        btn.textContent = open ? btn.dataset.altLabelOpen : btn.dataset.altLabelClosed;
      } else {
        btn.textContent = open ? "Hide formulas" : "Show formulas";
      }

      if (window.MathJax) {
        if (MathJax.typesetPromise) {
          MathJax.typesetPromise([box]).catch(() => {});
        } else if (MathJax.typeset) {
          MathJax.typeset([box]);
        }
      }
    });
  }

  // ============================================================
  // PHYSICAL CONSTANTS
  // ============================================================
  const C_LIGHT = 299792.458; // km/s
  const MPC_IN_KM = 3.085677581e19; // km in 1 Mpc
  const SEC_PER_GYR = 3.15576e16; // s in 1 Gyr

  // ============================================================
  // ΛCDM BACKGROUND FUNCTIONS (with curvature, general Ω's)
  // ============================================================
  function E_z(z, Om0, Or0, Ol0) {
    const Ok0 = 1 - Om0 - Or0 - Ol0;
    const zp1 = 1 + z;
    return Math.sqrt(
      Om0 * zp1 ** 3 +
        Or0 * zp1 ** 4 +
        Ok0 * zp1 ** 2 +
        Ol0
    );
  }

  function E_a(a, Om0, Or0, Ol0) {
    const Ok0 = 1 - Om0 - Or0 - Ol0;
    return Math.sqrt(
      Om0 / (a ** 3) +
        Or0 / (a ** 4) +
        Ok0 / (a ** 2) +
        Ol0
    );
  }

  function standardOmegaR0(H0, Tcmb = 2.7255, Neff = 3.046) {
    // Approx Planck-ish formula for Ω_r0(h, Tcmb, Neff)
    const h = H0 / 100;
    const Omega_gamma_0 = 2.47e-5 * Math.pow(Tcmb / 2.7255, 4) / (h * h);
    return Omega_gamma_0 * (1 + 0.2271 * Neff);
  }

  // Simpson integration helper: ensures even N
  function simpsonIntegrate(fn, x0, x1, N) {
    let n = Math.max(2, N | 0);
    if (n % 2 === 1) n += 1;
    const h = (x1 - x0) / n;
    let sum = 0;
    for (let i = 0; i <= n; i++) {
      const x = x0 + i * h;
      const w = (i === 0 || i === n) ? 1 : (i % 2 === 0 ? 2 : 4);
      sum += w * fn(x);
    }
    return (h / 3) * sum;
  }

  function integrateChiDimless(Om0, Or0, Ol0, zmax, Nsteps) {
    return simpsonIntegrate(
      (z) => 1 / E_z(z, Om0, Or0, Ol0),
      0,
      zmax,
      Math.max(200, Nsteps | 0)
    );
  }

  function lcdmDistancesAtZ(H0, Om0, Or0, Ol0, z, Nsteps) {
    const Ok0 = 1 - Om0 - Or0 - Ol0;
    const DH = C_LIGHT / H0; // Mpc
    const chiDimless = integrateChiDimless(Om0, Or0, Ol0, z, Nsteps);
    const DC = DH * chiDimless;

    let DM;
    if (Math.abs(Ok0) < 1e-7) {
      DM = DC;
    } else {
      const sqrtOk = Math.sqrt(Math.abs(Ok0));
      if (Ok0 > 0) {
        DM = DH / sqrtOk * Math.sinh(sqrtOk * chiDimless);
      } else {
        DM = DH / sqrtOk * Math.sin(sqrtOk * chiDimless);
      }
    }

    const DA = DM / (1 + z);
    const DL = DM * (1 + z);
    return { DC, DM, DA, DL };
  }

  function integrateLookbackTime(H0, Om0, Or0, Ol0, zmax, Nsteps) {
    const integral = simpsonIntegrate(
      (z) => 1 / ((1 + z) * E_z(z, Om0, Or0, Ol0)),
      0,
      zmax,
      Math.max(400, Nsteps | 0)
    );
    const H0_s = H0 / MPC_IN_KM; // 1/s
    const t_seconds = integral / H0_s;
    return t_seconds / SEC_PER_GYR; // Gyr
  }

  function computeDv(H0, Om0, Or0, Ol0, z, DA, Ez) {
    const H = H0 * Ez;
    const term = Math.pow(1 + z, 2) * DA * DA * (C_LIGHT * z / H);
    return Math.cbrt(term);
  }

  function differentialVolume(H0, Om0, Or0, Ol0, z, DM, Ez) {
    const H = H0 * Ez;
    return (C_LIGHT / H) * DM * DM;
  }

  // ============================================================
  // QKDE K(a) (Option B background uses this)
  // ============================================================
  // K(N) = 1 + K0 e^{-pN}, N = ln a ⇒ K(a) = 1 + K0 a^{-p}
  function K_a(a, K0, p) {
    return 1 + K0 * Math.pow(a, -p);
  }

  // ============================================================
  // GROWTH SOLVER (GENERAL BACKGROUND)
  // D'' + (2 + H'/H)D' - 3/2 Ω_m(a) D = 0, N = ln a
  // ============================================================
  function solveGrowthArray(aArray, E_func, Om0) {
    if (!aArray.length) return [];

    const a_min = aArray[0];
    const N_start = Math.log(a_min);
    const N_end = 0.0; // ln(1)
    const steps = 1500;
    const dN = (N_end - N_start) / steps;

    // Deep matter era IC: D ∝ a => D(a_min) = a_min, D' = D
    let D = a_min;
    let F = D;
    let N = N_start;

    const results = [];
    let index = 0;
    let a_target = aArray[index];

    function dlnH_dN(a) {
      const E = E_func(a);
      const eps = 1e-5;
      const aPlus = a * (1 + eps);
      const aMinus = a / (1 + eps);
      const EPlus = E_func(aPlus);
      const EMinus = E_func(aMinus);
      const dlnE_dlnA =
        (Math.log(EPlus) - Math.log(EMinus)) /
        (2 * Math.log(1 + eps));
      return dlnE_dlnA;
    }

    function derivs(Nv, Dv, Fv) {
      const a = Math.exp(Nv);
      const E = E_func(a);
      const OmA = (Om0 / (a * a * a)) / (E * E);
      const dlnH = dlnH_dN(a);
      return {
        Dp: Fv,
        Fp: -(2 + dlnH) * Fv + 1.5 * OmA * Dv
      };
    }

    function rkStep(Nv, Dv, Fv, h) {
      const k1 = derivs(Nv, Dv, Fv);
      const k2 = derivs(
        Nv + h / 2,
        Dv + (h * k1.Dp) / 2,
        Fv + (h * k1.Fp) / 2
      );
      const k3 = derivs(
        Nv + h / 2,
        Dv + (h * k2.Dp) / 2,
        Fv + (h * k2.Fp) / 2
      );
      const k4 = derivs(
        Nv + h,
        Dv + h * k3.Dp,
        Fv + h * k3.Fp
      );
      return {
        D:
          Dv +
          (h / 6) *
            (k1.Dp + 2 * k2.Dp + 2 * k3.Dp + k4.Dp),
        F:
          Fv +
          (h / 6) *
            (k1.Fp + 2 * k2.Fp + 2 * k3.Fp + k4.Fp)
      };
    }

    while (index < aArray.length) {
      const N_target = Math.log(a_target);
      if (N < N_target - 1e-10) {
        const step = rkStep(N, D, F, dN);
        D = step.D;
        F = step.F;
        N += dN;
      } else {
        results.push(D);
        index++;
        if (index < aArray.length) {
          a_target = aArray[index];
        }
      }
    }

    // Normalize to D(a=1) = 1
    const D_today = results[results.length - 1];
    return results.map((val) => val / D_today);
  }

  function solveGrowthAtZ_LCDM(z, Om0, Or0, Ol0) {
    const a_target = 1 / (1 + z);
    if (a_target <= 1e-3) {
      throw new Error("Growth solver requires z ≲ 1000 (a ≥ 10⁻³).");
    }

    const a_min = 1e-3;
    const Npts = 400;
    const aArray = Array.from({ length: Npts }, (_, i) =>
      a_min + (1 - a_min) * (i / (Npts - 1))
    );

    const E_LCDM = (a) => E_a(a, Om0, Or0, Ol0);
    const Darr = solveGrowthArray(aArray, E_LCDM, Om0);

    // Nearest index to a_target
    let idx = 0;
    let bestDiff = Infinity;
    for (let i = 0; i < aArray.length; i++) {
      const diff = Math.abs(aArray[i] - a_target);
      if (diff < bestDiff) {
        bestDiff = diff;
        idx = i;
      }
    }

    const Dnorm = Darr[idx];

    // f = d ln D / d ln a
    const i0 = Math.max(1, Math.min(aArray.length - 2, idx));
    const a_minus = aArray[i0 - 1];
    const a_plus = aArray[i0 + 1];
    const D_minus = Darr[i0 - 1];
    const D_plus = Darr[i0 + 1];

    const f =
      (Math.log(D_plus) - Math.log(D_minus)) /
      (Math.log(a_plus) - Math.log(a_minus));

    return { Dnorm, f };
  }

  // ============================================================
  // MAIN INIT
  // ============================================================
  window.addEventListener("DOMContentLoaded", () => {
    // ------------------------------------------------------------
    // Theme toggle
    // ------------------------------------------------------------
    const themeToggle = byId("theme-toggle");
    if (themeToggle) {
      // Restore persisted theme if present
      const storedTheme = localStorage.getItem("qkde-theme");
      if (storedTheme === "light" || storedTheme === "dark") {
        document.documentElement.setAttribute("data-theme", storedTheme);
        themeToggle.textContent =
          storedTheme === "dark" ? "Light mode" : "Dark mode";
      }

      themeToggle.addEventListener("click", () => {
        const root = document.documentElement;
        const current = root.getAttribute("data-theme") || "dark";
        const next = current === "dark" ? "light" : "dark";
        root.setAttribute("data-theme", next);
        themeToggle.textContent =
          next === "dark" ? "Light mode" : "Dark mode";
        localStorage.setItem("qkde-theme", next);
      });
    }

    // ------------------------------------------------------------
    // Panel collapsibles
    // ------------------------------------------------------------
    document
      .querySelectorAll(".panel-toggle-btn")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          const panelId = btn.getAttribute("data-panel");
          if (!panelId) return;
          const panel = byId(panelId);
          if (!panel) return;
          panel.classList.toggle("collapsed");
          const isCollapsed = panel.classList.contains("collapsed");
          btn.textContent = isCollapsed ? "Show" : "Hide";
        });
      });

    // ------------------------------------------------------------
    // Formula toggles
    // ------------------------------------------------------------
    attachFormulaToggle("lcdm-formula-toggle", "lcdm-formulas");
    attachFormulaToggle("qkde-formula-toggle", "qkde-formulas");
    attachFormulaToggle("grow-formula-toggle", "grow-formulas");

    // ============================================================
    // PANEL 1B: ΛCDM BACKGROUND DASHBOARD
    // ============================================================
    let lcdmChart = null;

    function updateLCDMChart(params, plotType) {
      const { H0, Om0, Or0, Ol0, zPlotMax, Nchi } = params;

      const Nz = 180;
      const dz = zPlotMax / Nz;

      const zArr = [];
      const EArr = [];
      const HArr = [];
      const DCarr = [];
      const DMarr = [];
      const DAarr = [];
      const DLarr = [];

      for (let i = 0; i <= Nz; i++) {
        const z = i * dz;
        zArr.push(z);
        const Ez = E_z(z, Om0, Or0, Ol0);
        const H = H0 * Ez;
        const dists = lcdmDistancesAtZ(H0, Om0, Or0, Ol0, z, Nchi);

        EArr.push(Ez);
        HArr.push(H / H0);
        DCarr.push(dists.DC);
        DMarr.push(dists.DM);
        DAarr.push(dists.DA);
        DLarr.push(dists.DL);
      }

      let yArr, yLabel;
      switch (plotType) {
        case "H":
          yArr = HArr;
          yLabel = "H(z)/H₀";
          break;
        case "DC":
          yArr = DCarr;
          yLabel = "D_C(z) [Mpc]";
          break;
        case "DM":
          yArr = DMarr;
          yLabel = "D_M(z) [Mpc]";
          break;
        case "DA":
          yArr = DAarr;
          yLabel = "D_A(z) [Mpc]";
          break;
        case "DL":
          yArr = DLarr;
          yLabel = "D_L(z) [Mpc]";
          break;
        case "E":
        default:
          yArr = EArr;
          yLabel = "E(z)";
          break;
      }

      const canvas = byId("lcdm-canvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (lcdmChart) lcdmChart.destroy();

      lcdmChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: zArr.map((v) => v.toFixed(2)),
          datasets: [
            {
              label: yLabel,
              data: yArr,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: "Redshift z" }
            },
            y: {
              title: { display: true, text: yLabel }
            }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    }

    const lcdmComputeBtn = byId("lcdm-compute");
    if (lcdmComputeBtn) {
      lcdmComputeBtn.addEventListener("click", () => {
        try {
          const z = parseFloat(byId("lcdm-z").value);
          let H0 = parseFloat(byId("lcdm-h0").value);
          let Om0 = parseFloat(byId("lcdm-om").value);
          let Or0 = parseFloat(byId("lcdm-or").value);
          let Ol0 = parseFloat(byId("lcdm-ol").value);
          const steps = parseInt(byId("lcdm-steps").value, 10);
          const zPlotMax = parseFloat(byId("lcdm-zmax-plot").value);
          const plotType = byId("lcdm-plot-y").value;
          const autoRad = byId("lcdm-auto-rad").checked;
          const enforceFlat = byId("lcdm-flat").checked;

          if (!(z >= 0)) throw new Error("Redshift z must be ≥ 0.");
          if (!(H0 > 0)) throw new Error("H₀ must be positive.");
          if (!(steps >= 200))
            throw new Error("z-steps must be ≥ 200.");
          if (!(zPlotMax > 0))
            throw new Error("Plot z_max must be > 0.");

          if (autoRad) {
            Or0 = standardOmegaR0(H0);
            byId("lcdm-or").value = Or0.toExponential(3);
          }

          if (enforceFlat) {
            Ol0 = 1 - Om0 - Or0;
            byId("lcdm-ol").value = Ol0.toFixed(6);
          }

          const Ok0 = 1 - Om0 - Or0 - Ol0;
          const okField = byId("lcdm-ok");
          if (okField) okField.value = Ok0.toFixed(6);

          const Otot0 = Om0 + Or0 + Ol0 + Ok0;
          if (!(Otot0 > 0)) {
            throw new Error("Ω_total must be > 0.");
          }

          const Ez = E_z(z, Om0, Or0, Ol0);
          const H = H0 * Ez;
          const dists = lcdmDistancesAtZ(H0, Om0, Or0, Ol0, z, steps);
          const DC = dists.DC;
          const DM = dists.DM;
          const DA = dists.DA;
          const DL = dists.DL;
          const mu = 5 * Math.log10(DL) + 25;

          const E2 = Ez * Ez;
          const zp1 = 1 + z;
          const OmegaMz = (Om0 * zp1 ** 3) / E2;
          const OmegaRz = (Or0 * zp1 ** 4) / E2;
          const OmegaLz = Ol0 / E2;
          const OmegaKz = (Ok0 * zp1 ** 2) / E2;

          const tL = integrateLookbackTime(
            H0,
            Om0,
            Or0,
            Ol0,
            z,
            steps
          );
          const t0 = integrateLookbackTime(
            H0,
            Om0,
            Or0,
            Ol0,
            4000,
            steps * 2
          );
          const t_z = t0 - tL;

          const Dv = computeDv(H0, Om0, Or0, Ol0, z, DA, Ez);
          const dV_dzdO = differentialVolume(
            H0,
            Om0,
            Or0,
            Ol0,
            z,
            DM,
            Ez
          );

          setOutput(
            byId("lcdm-output"),
            `=== ΛCDM Background @ z = ${z.toFixed(4)} ===
H₀            = ${H0.toFixed(3)} km/s/Mpc

Ωₘ₀           = ${Om0.toFixed(6)}
Ωᵣ₀           = ${Or0.toExponential(3)}
ΩΛ₀           = ${Ol0.toFixed(6)}
Ωₖ₀           = ${Ok0.toFixed(6)}
Ω_total(0)    = ${Otot0.toFixed(6)}

E(z)          = ${Ez.toFixed(6)}
H(z)          = ${H.toFixed(4)} km/s/Mpc

D_C(z)        = ${DC.toFixed(4)} Mpc  (comoving line-of-sight)
D_M(z)        = ${DM.toFixed(4)} Mpc  (transverse comoving)
D_A(z)        = ${DA.toFixed(4)} Mpc
D_L(z)        = ${DL.toFixed(4)} Mpc
μ(z)          = ${mu.toFixed(4)} mag

Ω_m(z)        = ${OmegaMz.toFixed(6)}
Ω_r(z)        = ${OmegaRz.toExponential(3)}
Ω_Λ(z)        = ${OmegaLz.toFixed(6)}
Ω_k(z)        = ${OmegaKz.toFixed(6)}

t_L(z)        = ${tL.toFixed(3)} Gyr (lookback)
t(z)          = ${t_z.toFixed(3)} Gyr (cosmic time)
t₀            = ${t0.toFixed(3)} Gyr (age of Universe)

D_V(z)        = ${Dv.toFixed(4)} Mpc
dV/dz dΩ      = ${dV_dzdO.toExponential(3)} Mpc³`
          );

          updateLCDMChart(
            {
              H0,
              Om0,
              Or0,
              Ol0,
              zPlotMax,
              Nchi: steps
            },
            plotType
          );
        } catch (err) {
          setOutput(byId("lcdm-output"), err.message, true);
        }
      });
    }

    // ΛCDM presets
    (function attachLCDMPresets() {
      const buttons = document.querySelectorAll(
        "#lcdm-card [data-lcdm-preset]"
      );
      if (!buttons.length) return;

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          buttons.forEach((b) => b.classList.remove("is-active"));
          btn.classList.add("is-active");

          const preset = btn.dataset.lcdmPreset;
          const H0Input = byId("lcdm-h0");
          const OmInput = byId("lcdm-om");
          const OrInput = byId("lcdm-or");
          const OlInput = byId("lcdm-ol");
          const flatBox = byId("lcdm-flat");
          const autoRad = byId("lcdm-auto-rad");

          if (!H0Input || !OmInput || !OrInput || !OlInput) return;

          if (preset === "planck") {
            H0Input.value = 67.4;
            OmInput.value = 0.315;
          } else if (preset === "local") {
            H0Input.value = 73.0;
            OmInput.value = 0.30;
          } else if (preset === "wmap") {
            H0Input.value = 70.0;
            OmInput.value = 0.28;
          }

          autoRad.checked = true;
          const H0 = parseFloat(H0Input.value);
          const Or0 = standardOmegaR0(H0);
          OrInput.value = Or0.toExponential(3);

          flatBox.checked = true;
          const Om0 = parseFloat(OmInput.value);
          const Ol0 = 1 - Om0 - Or0;
          OlInput.value = Ol0.toFixed(6);

          const Ok0 = 1 - Om0 - Or0 - Ol0;
          const okField = byId("lcdm-ok");
          if (okField) okField.value = Ok0.toFixed(6);
        });
      });
    })();

    // CSV export
    const lcdmCsvBtn = byId("lcdm-export-csv");
    if (lcdmCsvBtn) {
      lcdmCsvBtn.addEventListener("click", () => {
        try {
          const H0 = parseFloat(byId("lcdm-h0").value);
          const Om0 = parseFloat(byId("lcdm-om").value);
          let Or0 = parseFloat(byId("lcdm-or").value);
          let Ol0 = parseFloat(byId("lcdm-ol").value);
          const autoRad = byId("lcdm-auto-rad").checked;
          const enforceFlat = byId("lcdm-flat").checked;
          const zPlotMax = parseFloat(
            byId("lcdm-zmax-plot").value
          );

          if (!(H0 > 0)) throw new Error("H₀ must be positive.");
          if (!(zPlotMax > 0))
            throw new Error("Plot z_max must be > 0.");

          if (autoRad) Or0 = standardOmegaR0(H0);
          if (enforceFlat) Ol0 = 1 - Om0 - Or0;

          const Nz = 200;
          const dz = zPlotMax / Nz;

          const rows = [];
          rows.push(
            [
              "z",
              "E(z)",
              "H_over_H0",
              "D_C_Mpc",
              "D_M_Mpc",
              "D_A_Mpc",
              "D_L_Mpc",
              "mu_mag",
              "dV_dz_dOmega_Mpc3"
            ].join(",")
          );

          for (let i = 0; i <= Nz; i++) {
            const z = i * dz;
            const Ez = E_z(z, Om0, Or0, Ol0);
            const dists = lcdmDistancesAtZ(
              H0,
              Om0,
              Or0,
              Ol0,
              z,
              600
            );
            const DC = dists.DC;
            const DM = dists.DM;
            const DA = dists.DA;
            const DL = dists.DL;
            const mu = 5 * Math.log10(DL) + 25;
            const dV = differentialVolume(
              H0,
              Om0,
              Or0,
              Ol0,
              z,
              DM,
              Ez
            );

            rows.push(
              [
                z.toFixed(6),
                Ez.toFixed(8),
                Ez.toFixed(8),
                DC.toFixed(8),
                DM.toFixed(8),
                DA.toFixed(8),
                DL.toFixed(8),
                mu.toFixed(8),
                dV.toExponential(8)
              ].join(",")
            );
          }

          const blob = new Blob([rows.join("\n")], {
            type: "text/csv"
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "lcdm_background_z_grid.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (err) {
          alert("CSV export error: " + err.message);
        }
      });
    }

    // ============================================================
    // PANEL 2: QKDE RUNNING K
    // ============================================================
    const qkdeComputeBtn = byId("qkde-compute");
    if (qkdeComputeBtn) {
      qkdeComputeBtn.addEventListener("click", () => {
        try {
          const z = parseFloat(byId("qkde-z").value);
          const K0 = parseFloat(byId("qkde-k0").value);
          const p = parseFloat(byId("qkde-p").value);

          if (!isFinite(z)) throw new Error("Invalid z.");
          if (!isFinite(K0)) throw new Error("Invalid K₀.");
          if (!isFinite(p)) throw new Error("Invalid p.");

          const a = 1 / (1 + z);
          const K = K_a(a, K0, p);
          const K_today = 1 + K0;

          const dlnK_dlnA = (-p * K0 * Math.pow(a, -p)) / K;

          setOutput(
            byId("qkde-output"),
            `Scale factor a = ${a.toFixed(4)}
K(a)         = ${K.toFixed(6)}
K(0)         = ${K_today.toFixed(6)}
d ln K / d ln a (a) = ${dlnK_dlnA.toFixed(6)}`
          );
        } catch (err) {
          setOutput(byId("qkde-output"), err.message, true);
        }
      });
    }

    // QKDE presets
    (function attachQKDEPresets() {
      const buttons = document.querySelectorAll(
        "#qkde-card [data-qkde-preset]"
      );
      if (!buttons.length) return;

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          buttons.forEach((b) => b.classList.remove("is-active"));
          btn.classList.add("is-active");

          const preset = btn.dataset.qkdePreset;
          const K0Input = byId("qkde-k0");
          const pInput = byId("qkde-p");
          if (!K0Input || !pInput) return;

          if (preset === "mild") {
            K0Input.value = 0.5;
            pInput.value = 1.0;
          } else if (preset === "strong") {
            K0Input.value = 1.0;
            pInput.value = 3.0;
          }
        });
      });
    })();

    // ============================================================
    // PANEL 3: GR GROWTH AT ONE REDSHIFT
    // ============================================================
    const growComputeBtn = byId("grow-compute");
    if (growComputeBtn) {
      growComputeBtn.addEventListener("click", () => {
        try {
          const z = parseFloat(byId("lcdm-z").value);
          const Om = parseFloat(byId("grow-om0").value);
          const Or = parseFloat(byId("grow-or0").value);
          const Ol = parseFloat(byId("grow-ol0").value);

          const result = solveGrowthAtZ_LCDM(z, Om, Or, Ol);

          setOutput(
            byId("grow-output"),
            `D(z) (normalized) = ${result.Dnorm.toFixed(6)}
f(z)               = ${result.f.toFixed(6)}`
          );
        } catch (err) {
          setOutput(byId("grow-output"), err.message, true);
        }
      });
    }

    // ============================================================
    // PANEL 4: ΛCDM vs QKDE SNAPSHOT (Option B-style consistency)
    // ============================================================
    const cmpComputeBtn = byId("cmp-compute");
    if (cmpComputeBtn) {
      cmpComputeBtn.addEventListener("click", () => {
        try {
          const z = parseFloat(byId("cmp-z").value);
          const Om0 = parseFloat(byId("lcdm-om").value);
          const Or0 = parseFloat(byId("lcdm-or").value);
          const H0 = parseFloat(byId("lcdm-h0").value);
          const K0 = parseFloat(byId("cmp-k0").value);
          const p = parseFloat(byId("cmp-p").value);

          if (!isFinite(z)) throw new Error("Invalid z.");
          if (!isFinite(Om0) || !isFinite(Or0))
            throw new Error("Invalid Ω parameters.");
          if (!isFinite(H0) || H0 <= 0)
            throw new Error("H₀ must be positive.");
          if (!isFinite(K0) || !isFinite(p))
            throw new Error("Invalid QKDE parameters.");

          const a = 1 / (1 + z);

          // ΛCDM: assume flat for comparison snapshot
          const Ol0_LCDM = 1 - Om0 - Or0;
          const H_LCDM = H0 * E_z(z, Om0, Or0, Ol0_LCDM);

          // QKDE Option B: DE replaces Λ with ρ_DE(a)=ρ_DE,0 K(1)/K(a)
          const ODE0 = 1 - Om0 - Or0;
          const K_today = 1 + K0;
          const K_here = K_a(a, K0, p);
          const E_QKDE = Math.sqrt(
            Om0 * a ** -3 +
              Or0 * a ** -4 +
              ODE0 * (K_today / K_here)
          );
          const H_QKDE = H0 * E_QKDE;

          const growthL = solveGrowthAtZ_LCDM(
            z,
            Om0,
            Or0,
            Ol0_LCDM
          );

          setOutput(
            byId("cmp-output"),
            `=== Snapshot @ z = ${z.toFixed(4)} ===
ΛCDM:
  H_LCDM(z)  = ${H_LCDM.toFixed(4)} km/s/Mpc
  D_LCDM(z)  = ${growthL.Dnorm.toFixed(6)}
  f_LCDM(z)  = ${growthL.f.toFixed(6)}

QKDE (ρ_DE ∝ K(1)/K(a)):
  K(a)       = ${K_here.toFixed(6)}
  K(1)       = ${K_today.toFixed(6)}
  H_QKDE(z)  = ${H_QKDE.toFixed(4)} km/s/Mpc
`
          );
        } catch (err) {
          setOutput(byId("cmp-output"), err.message, true);
        }
      });
    }

    // ============================================================
    // PANEL 5: ADVANCED GROWTH COMPARATOR
    // ============================================================
    let growthChart = null;

    const advComputeBtn = byId("adv-growth-compute");
    if (advComputeBtn) {
      advComputeBtn.addEventListener("click", () => {
        try {
          const Om0 = parseFloat(byId("adv-om0").value);
          const Or0 = parseFloat(byId("adv-or0").value);
          const zmax = parseFloat(byId("adv-zmax").value);
          const Npts = parseInt(byId("adv-samples").value, 10);

          const wQ = parseFloat(byId("adv-wq").value);
          const w0 = parseFloat(byId("adv-w0").value);
          const wa = parseFloat(byId("adv-wa").value);
          const K0q = parseFloat(byId("adv-k0q").value);
          const pq = parseFloat(byId("adv-pq").value);

          const showLCDM = byId("adv-show-lcdm").checked;
          const showQ = byId("adv-show-quint").checked;
          const showCPL = byId("adv-show-kess").checked;
          const showQKDE = byId("adv-show-qkde").checked;

          const xMode = byId("adv-xaxis").value; // "a" or "z"
          const norm = byId("adv-norm").value; // "Da" or "Da_over_a"

          if (!(zmax > 0)) throw new Error("z_max must be > 0.");
          if (!(Npts >= 40)) throw new Error("Samples must be ≥ 40.");

          const ODE0 = 1 - Om0 - Or0; // flat for all models here
          if (ODE0 <= 0) {
            throw new Error(
              "Ω_DE,0 ≤ 0. Choose Ωₘ₀ + Ωᵣ₀ < 1 for the growth comparator."
            );
          }

          const a_min = 1 / (1 + zmax);
          const aArray = Array.from({ length: Npts }, (_, i) =>
            a_min + (1 - a_min) * (i / (Npts - 1))
          );

          const E_LCDM = (a) =>
            Math.sqrt(Om0 / a ** 3 + Or0 / a ** 4 + ODE0);

          const E_Quint = (a) =>
            Math.sqrt(
              Om0 / a ** 3 +
                Or0 / a ** 4 +
                ODE0 * a ** (-3 * (1 + wQ))
            );

          const E_CPL = (a) => {
            const ode =
              ODE0 *
              a ** (-3 * (1 + w0 + wa)) *
              Math.exp(-3 * wa * (1 - a));
            return Math.sqrt(
              Om0 / a ** 3 +
                Or0 / a ** 4 +
                ode
            );
          };

          const K_today = 1 + K0q;
          const E_QKDE = (a) => {
            const K = K_a(a, K0q, pq);
            return Math.sqrt(
              Om0 / a ** 3 +
                Or0 / a ** 4 +
                ODE0 * (K_today / K)
            );
          };

          function maybeNormalizeDa(Darr) {
            if (norm === "Da_over_a") {
              return Darr.map((D, i) => D / aArray[i]);
            }
            return Darr;
          }

          const datasets = [];

          if (showLCDM) {
            const D_L = maybeNormalizeDa(
              solveGrowthArray(aArray, E_LCDM, Om0)
            );
            datasets.push({
              label: "ΛCDM",
              data: D_L,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            });
          }

          if (showQ) {
            const D_Q = maybeNormalizeDa(
              solveGrowthArray(aArray, E_Quint, Om0)
            );
            datasets.push({
              label: "Quintessence (w)",
              data: D_Q,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            });
          }

          if (showCPL) {
            const D_C = maybeNormalizeDa(
              solveGrowthArray(aArray, E_CPL, Om0)
            );
            datasets.push({
              label: "CPL",
              data: D_C,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            });
          }

          if (showQKDE) {
            const D_QK = maybeNormalizeDa(
              solveGrowthArray(aArray, E_QKDE, Om0)
            );
            datasets.push({
              label: "QKDE (ρ∝K(1)/K(a))",
              data: D_QK,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.15
            });
          }

          const xLabels =
            xMode === "z"
              ? aArray.map((a) => (1 / a - 1).toFixed(3))
              : aArray.map((a) => a.toFixed(3));

          const xTitle =
            xMode === "z" ? "Redshift z" : "Scale factor a";
          const yTitle =
            norm === "Da_over_a"
              ? "D(a)/a (normalized)"
              : "D(a) (D(1)=1)";

          const advCanvas = byId("adv-growth-canvas");
          if (!advCanvas) return;
          const ctx = advCanvas.getContext("2d");
          if (growthChart) growthChart.destroy();

          growthChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: xLabels,
              datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  title: { display: true, text: xTitle }
                },
                y: {
                  title: { display: true, text: yTitle }
                }
              },
              plugins: {
                legend: { display: true }
              }
            }
          });

          setOutput(
            byId("adv-growth-info"),
            `Plotted:
${showLCDM ? "• ΛCDM\n" : ""}${
              showQ ? "• Quintessence (constant w)\n" : ""
            }${showCPL ? "• CPL w(a)\n" : ""}${
              showQKDE ? "• QKDE (ρ∝K(1)/K(a))\n" : ""
            }`
          );
        } catch (err) {
          setOutput(byId("adv-growth-info"), err.message, true);
        }
      });
    }
  });
})();
</script>
