<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QKDE Lab ‚Äì Cosmology Analysis Environment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Plotly for interactive plotting -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
</head>
<body>

<div class="page" id="qkde-lab-page">

  <!-- ======================= TITLE & INTRO ======================= -->
  <header>
    <h1>QKDE Cosmology Lab</h1>
    <p class="center" style="opacity:0.9;">
      ŒõCDM ‚Ä¢ wCDM ‚Ä¢ CPL ‚Ä¢ QKDE ‚Ä¢ SN Ia ‚Ä¢ BAO ‚Ä¢ H(z) ‚Ä¢ fœÉ‚Çà ‚Ä¢ œá¬≤ Fits
    </p>

    <p class="calc-intro">
      <strong>QKDE Lab</strong> is a single integrated environment for serious cosmology work:
      compare backgrounds, distances, and growth across multiple models, overlay real data,
      and compute simple œá¬≤ statistics ‚Äì all in the browser, with exact GR equations.
    </p>

    <details style="margin-top:8px;">
      <summary><strong>üß™ How to use QKDE Lab (quick guide)</strong></summary>
      <div style="margin-top:8px; font-size:0.9rem; opacity:0.95;">
        <ol style="padding-left:18px;">
          <li>
            <strong>Choose models</strong> in the left panel (ŒõCDM, wCDM, CPL, QKDE).
          </li>
          <li>
            <strong>Set parameters</strong> (H‚ÇÄ, Œ©‚Çò‚ÇÄ, Œ©·µ£‚ÇÄ, w, K‚ÇÄ, p, etc.).
          </li>
          <li>
            <strong>Select a quantity</strong> and a tab on the right
            (<em>Background</em>, <em>Distances</em>, <em>Growth</em>, <em>Data vs Models</em>, <em>QKDE Diagnostics</em>).
          </li>
          <li>
            <strong>(Optional) Load data</strong> via CSV (SN, BAO, H(z), or fœÉ‚Çà) and
            press <em>Compute œá¬≤</em> to get model-data comparisons.
          </li>
          <li>
            Use the <strong>Export Plot</strong> button on the plot toolbar to save publication-quality figures.
          </li>
        </ol>
        <p>
          This page is designed to complement the simpler QKDE calculators: here you get one
          unified, research-oriented lab instead of many small tools.
        </p>
      </div>
    </details>
  </header>

  <!-- ======================= LAYOUT ======================= -->
  <main id="lab-layout" style="display:flex; gap:1rem; margin-top:1rem; flex-wrap:wrap;">

    <!-- ================= LEFT: CONTROL SIDEBAR ================= -->
    <aside id="lab-controls" style="flex:0 0 320px; max-width:360px;">
      <!-- MODEL SELECTION -->
      <section class="lab-block" aria-labelledby="lab-models-title">
        <h2 id="lab-models-title">1. Models</h2>
        <p style="font-size:0.85rem; opacity:0.9;">
          Select which cosmological models to include. All share the same H‚ÇÄ and Œ©·µ£‚ÇÄ; each model
          has its own dark-energy parameters.
        </p>

        <div>
          <label>
            <input type="checkbox" class="lab-model-toggle" data-model="lcdm" checked>
            ŒõCDM (w = ‚àí1, K = const)
          </label><br>
          <label>
            <input type="checkbox" class="lab-model-toggle" data-model="wcdm" checked>
            wCDM (constant w)
          </label><br>
          <label>
            <input type="checkbox" class="lab-model-toggle" data-model="cpl" checked>
            CPL (w(a) = w‚ÇÄ + w‚Çê(1‚àía))
          </label><br>
          <label>
            <input type="checkbox" class="lab-model-toggle" data-model="qkde" checked>
            QKDE (œÅ<sub>DE</sub> ‚àù K(1)/K(a))
          </label>
        </div>
      </section>

      <!-- GLOBAL BACKGROUND PARAMETERS -->
      <section class="lab-block" aria-labelledby="lab-global-title">
        <h2 id="lab-global-title">2. Global Background</h2>

        <div class="calc-input-row">
          <div>
            <label class="calc-label" for="lab-h0">H‚ÇÄ [km/s/Mpc]</label>
            <input id="lab-h0" class="calc-input" type="number" value="67.4" step="0.1">
          </div>
          <div>
            <label class="calc-label" for="lab-om0">Œ©‚Çò‚ÇÄ</label>
            <input id="lab-om0" class="calc-input" type="number" value="0.315" step="0.001">
          </div>
        </div>

        <div class="calc-input-row">
          <div>
            <label class="calc-label" for="lab-or0">Œ©·µ£‚ÇÄ</label>
            <input id="lab-or0" class="calc-input" type="number" value="5e-5" step="1e-5">
          </div>
          <div>
            <label class="calc-label" for="lab-ode0">Œ©<sub>DE,0</sub></label>
            <input id="lab-ode0" class="calc-input" type="number" value="0.685" step="0.001">
          </div>
        </div>

        <div class="calc-input-row">
          <div>
            <label class="calc-label" for="lab-zmax">z<sub>max</sub> grid</label>
            <input id="lab-zmax" class="calc-input" type="number" value="3" step="0.1">
          </div>
          <div>
            <label class="calc-label" for="lab-nsamples">Samples</label>
            <input id="lab-nsamples" class="calc-input" type="number" value="300" min="50" step="50">
          </div>
        </div>

        <div>
          <label style="font-size:0.85rem;">
            <input type="checkbox" id="lab-flat" checked>
            Flat universe: Œ©‚Çñ‚ÇÄ = 0 (infer from others)
          </label>
        </div>
      </section>

      <!-- MODEL-SPECIFIC PARAMETERS -->
      <section class="lab-block" aria-labelledby="lab-model-params-title">
        <h2 id="lab-model-params-title">3. Dark-Energy & QKDE Parameters</h2>

        <details open>
          <summary><strong>ŒõCDM</strong> (w = ‚àí1)</summary>
          <p style="font-size:0.8rem; opacity:0.9;">
            No extra parameters beyond Œ©<sub>DE,0</sub>. Included for reference.
          </p>
        </details>

        <details open>
          <summary><strong>wCDM</strong></summary>
          <div class="calc-input-row">
            <div>
              <label class="calc-label" for="lab-wc">w (constant)</label>
              <input id="lab-wc" class="calc-input" type="number" value="-0.9" step="0.02">
            </div>
          </div>
        </details>

        <details open>
          <summary><strong>CPL</strong> w(a) = w‚ÇÄ + w‚Çê(1‚àía)</summary>
          <div class="calc-input-row">
            <div>
              <label class="calc-label" for="lab-w0">w‚ÇÄ</label>
              <input id="lab-w0" class="calc-input" type="number" value="-0.9" step="0.02">
            </div>
            <div>
              <label class="calc-label" for="lab-wa">w‚Çê</label>
              <input id="lab-wa" class="calc-input" type="number" value="0.2" step="0.05">
            </div>
          </div>
        </details>

        <details open>
          <summary><strong>QKDE</strong> (œÅ<sub>DE</sub> ‚àù K(1)/K(a))</summary>
          <div class="calc-input-row">
            <div>
              <label class="calc-label" for="lab-k0">K‚ÇÄ</label>
              <input id="lab-k0" class="calc-input" type="number" value="0.5" step="0.05">
            </div>
            <div>
              <label class="calc-label" for="lab-p">p</label>
              <input id="lab-p" class="calc-input" type="number" value="1.0" step="0.1">
            </div>
          </div>
          <p style="font-size:0.8rem; opacity:0.9;">
            We use K(a) = 1 + K‚ÇÄ a<sup>‚àíp</sup> and
            œÅ<sub>DE</sub>(a) ‚àù K(1)/K(a), giving
            w(a) = ‚àí1 ‚àí (1/3) d ln K / d ln a.
          </p>
        </details>
      </section>

      <!-- DATA IMPORT & FIT OPTIONS -->
      <section class="lab-block" aria-labelledby="lab-data-title">
        <h2 id="lab-data-title">4. Data & œá¬≤</h2>

        <p style="font-size:0.85rem; opacity:0.9;">
          Load observational datasets (CSV) and compare to models.
          Supported columns are shown under each input.
        </p>

        <details>
          <summary><strong>SN Ia</strong> (distance modulus Œº)</summary>
          <p style="font-size:0.8rem; opacity:0.9;">
            CSV columns: z, mu, sigma_mu
          </p>
          <input type="file" id="lab-data-sn" accept=".csv">
        </details>

        <details>
          <summary><strong>BAO</strong></summary>
          <p style="font-size:0.8rem; opacity:0.9;">
            CSV columns (example): z, DV, sigma_DV
          </p>
          <input type="file" id="lab-data-bao" accept=".csv">
        </details>

        <details>
          <summary><strong>H(z)</strong> (cosmic chronometers)</summary>
          <p style="font-size:0.8rem; opacity:0.9;">
            CSV columns: z, Hz, sigma_Hz
          </p>
          <input type="file" id="lab-data-hz" accept=".csv">
        </details>

        <details>
          <summary><strong>fœÉ‚Çà(z)</strong></summary>
          <p style="font-size:0.8rem; opacity:0.9;">
            CSV columns: z, fs8, sigma_fs8
          </p>
          <input type="file" id="lab-data-fs8" accept=".csv">
        </details>

        <div class="calc-input-row" style="margin-top:10px;">
          <div>
            <label class="calc-label" for="lab-fit-target">œá¬≤ target</label>
            <select id="lab-fit-target" class="calc-input">
              <option value="sn">SN Œº(z)</option>
              <option value="bao">BAO D<sub>V</sub>(z)</option>
              <option value="hz">H(z)</option>
              <option value="fs8">fœÉ‚Çà(z)</option>
            </select>
          </div>
        </div>

        <div class="calc-action-row" style="margin-top:8px;">
          <button class="calc-btn" id="lab-fit-chi2">Compute œá¬≤ (current params)</button>
        </div>

        <pre id="lab-chi2-output" class="calc-output-mini" style="margin-top:4px;"></pre>
      </section>

      <!-- PLOT CONFIG -->
      <section class="lab-block" aria-labelledby="lab-plot-title">
        <h2 id="lab-plot-title">5. Plot Configuration</h2>

        <div class="calc-input-row">
          <div>
            <label class="calc-label" for="lab-yquantity">Y quantity</label>
            <select id="lab-yquantity" class="calc-input">
              <option value="E">E(z)</option>
              <option value="Hz">H(z)</option>
              <option value="DC">D<sub>C</sub>(z)</option>
              <option value="DA">D<sub>A</sub>(z)</option>
              <option value="DL">D<sub>L</sub>(z)</option>
              <option value="mu">Œº(z)</option>
              <option value="growthD">D(a)</option>
              <option value="growthD_over_a">D(a)/a</option>
            </select>
          </div>
          <div>
            <label class="calc-label" for="lab-xaxis">X axis</label>
            <select id="lab-xaxis" class="calc-input">
              <option value="z">z</option>
              <option value="a">a</option>
            </select>
          </div>
        </div>

        <div class="calc-input-row">
          <div>
            <label class="calc-label" for="lab-scale-y">Y scale</label>
            <select id="lab-scale-y" class="calc-input">
              <option value="linear">Linear</option>
              <option value="log">Log</option>
            </select>
          </div>
          <div>
            <label class="calc-label" for="lab-z-eval">Single redshift z*</label>
            <input id="lab-z-eval" class="calc-input" type="number" value="0.5" step="0.01">
          </div>
        </div>

        <div class="calc-action-row" style="margin-top:8px;">
          <button class="calc-btn" id="lab-update-plots">Update Plots</button>
        </div>
      </section>
    </aside>

    <!-- ================= RIGHT: VISUALIZATION AREA ================= -->
    <section id="lab-visualization" style="flex:1 1 480px; min-width:0;">

      <!-- TAB BUTTONS -->
      <nav id="lab-tabs" style="margin-bottom:8px;">
        <button class="lab-tab-btn is-active" data-tab="background">Background</button>
        <button class="lab-tab-btn" data-tab="distances">Distances</button>
        <button class="lab-tab-btn" data-tab="growth">Growth</button>
        <button class="lab-tab-btn" data-tab="datavsmodels">Data vs Models</button>
        <button class="lab-tab-btn" data-tab="qkde">QKDE Diagnostics</button>
        <button class="lab-tab-btn" data-tab="summary">Summary</button>
      </nav>

      <!-- PANELS -->
      <div id="lab-panels">

        <!-- BACKGROUND PANEL -->
        <section class="lab-panel" data-tab="background" aria-label="Background panel">
          <h2>Background Expansion</h2>
          <p style="font-size:0.9rem; opacity:0.9;">
            E(z) and H(z) for the selected models. Use controls on the left to adjust parameters.
          </p>
          <div id="lab-plot-background" style="width:100%; height:360px;"></div>
          <pre id="lab-info-background" class="calc-output-mini"></pre>
        </section>

        <!-- DISTANCES PANEL -->
        <section class="lab-panel" data-tab="distances" aria-label="Distances panel" hidden>
          <h2>Distances</h2>
          <p style="font-size:0.9rem; opacity:0.9;">
            Comoving, angular-diameter, and luminosity distances, along with Œº(z).
          </p>
          <div id="lab-plot-distances" style="width:100%; height:360px;"></div>
          <pre id="lab-info-distances" class="calc-output-mini"></pre>
        </section>

        <!-- GROWTH PANEL -->
        <section class="lab-panel" data-tab="growth" aria-label="Growth panel" hidden>
          <h2>Linear Growth</h2>
          <p style="font-size:0.9rem; opacity:0.9;">
            GR growth D(a) solved on each background. Normalized to D(a=1)=1.
          </p>
          <div id="lab-plot-growth" style="width:100%; height:360px;"></div>
          <pre id="lab-info-growth" class="calc-output-mini"></pre>
        </section>

        <!-- DATA VS MODELS PANEL -->
        <section class="lab-panel" data-tab="datavsmodels" aria-label="Data vs Models panel" hidden>
          <h2>Data vs Models</h2>
          <p style="font-size:0.9rem; opacity:0.9;">
            Loaded datasets (SN, BAO, H(z), fœÉ‚Çà) plotted alongside model predictions.
            Use the left panel to load CSV and choose the œá¬≤ target.
          </p>
          <div id="lab-plot-data" style="width:100%; height:360px;"></div>
          <pre id="lab-info-data" class="calc-output-mini"></pre>
        </section>

        <!-- QKDE DIAGNOSTICS PANEL -->
        <section class="lab-panel" data-tab="qkde" aria-label="QKDE diagnostics panel" hidden>
          <h2>QKDE Diagnostics</h2>
          <p style="font-size:0.9rem; opacity:0.9;">
            K(a), w<sub>eff</sub>(a), and divergence from ŒõCDM as a function of time.
          </p>
          <div id="lab-plot-qkde" style="width:100%; height:360px;"></div>
          <pre id="lab-info-qkde" class="calc-output-mini"></pre>
        </section>

        <!-- SUMMARY PANEL -->
        <section class="lab-panel" data-tab="summary" aria-label="Summary panel" hidden>
          <h2>Model & Fit Summary</h2>
          <p style="font-size:0.9rem; opacity:0.9;">
            High-level summary of current parameters, key observables at z*, and œá¬≤ values
            for each active model (if data are loaded).
          </p>
          <pre id="lab-info-summary" class="calc-output" style="min-height:220px;"></pre>
        </section>

      </div>
    </section>
  </main>
</div> <!-- /page -->


<!-- ======================= LAB SCRIPT ======================= -->
<script>
(function() {
  "use strict";

  /* ========= STATE ========= */
  const state = {
    models: {
      lcdm: true,
      wcdm: true,
      cpl: true,
      qkde: true,
    },
    params: {},
    data: {
      sn: null,
      bao: null,
      hz: null,
      fs8: null,
    }
  };

  /* ========= UTILITIES ========= */
  const c_kms = 299792.458; // km/s

  function linspace(start, end, n) {
    const arr = new Array(n);
    const step = (end - start) / (n - 1);
    for (let i = 0; i < n; i++) {
      arr[i] = start + step * i;
    }
    return arr;
  }

  function trapz(x, y) {
    let sum = 0;
    for (let i = 1; i < x.length; i++) {
      sum += 0.5 * (y[i] + y[i-1]) * (x[i] - x[i-1]);
    }
    return sum;
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return null;
    const header = lines[0].split(",").map(h => h.trim());
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;
      const cols = line.split(",");
      const row = {};
      header.forEach((h, idx) => {
        const v = cols[idx] !== undefined ? cols[idx].trim() : "";
        const num = Number(v);
        row[h] = isNaN(num) ? v : num;
      });
      rows.push(row);
    }
    return { header, rows };
  }

  /* ========= MODEL BACKGROUND ========= */

  function E_of_z(model, z, p) {
    const Om0 = p.Om0;
    const Or0 = p.Or0;
    const Ode0 = p.Ode0;
    let Ok0 = 1 - Om0 - Or0 - Ode0;
    if (p.flat) Ok0 = 0;
    const zp1 = 1 + z;
    const rho_m = Om0 * Math.pow(zp1, 3);
    const rho_r = Or0 * Math.pow(zp1, 4);
    const rho_k = Ok0 * Math.pow(zp1, 2);
    let rho_de;

    if (model === "lcdm") {
      rho_de = Ode0;
    } else if (model === "wcdm") {
      const w = p.wc;
      rho_de = Ode0 * Math.pow(zp1, 3 * (1 + w));
    } else if (model === "cpl") {
      const w0 = p.w0;
      const wa = p.wa;
      const a = 1 / (1 + z);
      // CPL: rho_de ‚àù a^{-3(1+w0+wa)} exp[ -3 wa (1-a) ]
      const exponent = -3 * (1 + w0 + wa) * Math.log(a) - 3 * wa * (1 - a);
      rho_de = Ode0 * Math.exp(exponent);
    } else if (model === "qkde") {
      // QKDE: rho_de(a) ‚àù K(1)/K(a), K(a)=1+K0 a^{-p}
      const a = 1 / (1 + z);
      const K0 = p.K0;
      const pK = p.pK;
      const K_a = 1 + K0 * Math.pow(a, -pK);
      const K_1 = 1 + K0;
      rho_de = Ode0 * (K_1 / K_a);
    } else {
      rho_de = Ode0;
    }
    return Math.sqrt(rho_m + rho_r + rho_k + rho_de);
  }

  function computeBackgroundGrid(p) {
    const zmax = p.zmax;
    const n = p.nsamples;
    const zArr = linspace(0, zmax, n);
    const models = ["lcdm", "wcdm", "cpl", "qkde"];
    const result = {};
    models.forEach(m => {
      if (!state.models[m]) return;
      const E = zArr.map(z => E_of_z(m, z, p));
      const Hz = E.map(e => p.H0 * e);
      // comoving distance
      const invE = E.map(e => 1 / e);
      const Dc = [];
      for (let i = 0; i < zArr.length; i++) {
        const zSub = zArr.slice(0, i + 1);
        const invESub = invE.slice(0, i + 1);
        Dc.push((c_kms / p.H0) * trapz(zSub, invESub));
      }
      const aArr = zArr.map(z => 1 / (1 + z));
      result[m] = { z: zArr, a: aArr, E, Hz, Dc };
    });
    return result;
  }

  /* ========= GROWTH ========= */

  function computeGrowthOnBackground(bg, p) {
    // Simple GR growth solution in N = ln a
    const aArr = bg.a;
    const n = aArr.length;
    const NArr = aArr.map(a => Math.log(a));
    const D = new Array(n).fill(0);
    const Dp = new Array(n).fill(0);

    // set initial conditions at early a ~ first index (assume matter-dominated D ~ a)
    D[0] = aArr[0];
    Dp[0] = D[0]; // dD/dN ~ D in matter-domination

    for (let i = 1; i < n; i++) {
      const a = aArr[i];
      const z = 1 / a - 1;
      const E = bg.E[i];
      const HprimeOverH = compute_Hprime_over_H(bg, i, NArr);
      const Omz = omega_m_of_z(z, p, bg.E[i]);

      // Growth equation: D'' + (2 + H'/H) D' - 1.5 Om D = 0
      const Nstep = NArr[i] - NArr[i-1];
      const Dpp = (1.5 * Omz * D[i-1]) - (2 + HprimeOverH) * Dp[i-1];

      Dp[i] = Dp[i-1] + Dpp * Nstep;
      D[i] = D[i-1] + Dp[i-1] * Nstep;
    }

    // normalize to D(a=1)=1
    const idx1 = bg.a.reduce((bestIdx, a, idx) =>
      Math.abs(a - 1) < Math.abs(bg.a[bestIdx] - 1) ? idx : bestIdx, 0);
    const D1 = D[idx1] || 1;
    const Dnorm = D.map(val => val / D1);

    return { a: bg.a, z: bg.z, D: Dnorm };
  }

  function omega_m_of_z(z, p, E_z) {
    const Om0 = p.Om0;
    const Or0 = p.Or0;
    const Ode0 = p.Ode0;
    let Ok0 = 1 - Om0 - Or0 - Ode0;
    if (p.flat) Ok0 = 0;
    const zp1 = 1 + z;
    const num = Om0 * Math.pow(zp1, 3);
    const denom = Math.pow(E_z, 2);
    return num / denom;
  }

  function compute_Hprime_over_H(bg, i, NArr) {
    if (i === 0 || i === bg.E.length - 1) {
      return 0;
    }
    const lnH_next = Math.log(bg.Hz[i+1]);
    const lnH_prev = Math.log(bg.Hz[i-1]);
    const dN = NArr[i+1] - NArr[i-1];
    return (lnH_next - lnH_prev) / dN;
  }

  /* ========= œá¬≤ ========= */

  function computeChi2(target, modelName, bgGrid, growthGrid, p) {
    const data = state.data[target];
    if (!data || !data.rows.length) {
      return { chi2: null, ndof: null, message: "No data loaded for " + target };
    }
    let chi2 = 0;
    let n = 0;

    if (target === "sn") {
      const bg = bgGrid[modelName];
      if (!bg) return { chi2: null, ndof: null, message: "Model grid missing" };

      for (const row of data.rows) {
        const z = row.z;
        const mu_obs = row.mu;
        const sig = row.sigma_mu;
        if (!isFinite(z) || !isFinite(mu_obs) || !isFinite(sig) || sig <= 0) continue;
        const mu_th = mu_of_z(z, modelName, p);
        const diff = (mu_obs - mu_th) / sig;
        chi2 += diff * diff;
        n++;
      }
    } else if (target === "hz") {
      const bg = bgGrid[modelName];
      if (!bg) return { chi2: null, ndof: null, message: "Model grid missing" };
      for (const row of data.rows) {
        const z = row.z;
        const Hz_obs = row.Hz;
        const sig = row.sigma_Hz;
        if (!isFinite(z) || !isFinite(Hz_obs) || !isFinite(sig) || sig <= 0) continue;
        const Hz_th = H_of_z(z, modelName, p);
        const diff = (Hz_obs - Hz_th) / sig;
        chi2 += diff * diff;
        n++;
      }
    }
    // (You can extend BAO and fs8 following same pattern)

    return {
      chi2: n ? chi2 : null,
      ndof: n ? n : null,
      message: n ? "" : "No valid data points parsed."
    };
  }

  function mu_of_z(z, modelName, p) {
    // quick one-off DC and DL at z using trapz on small grid
    const zArr = linspace(0, z, 200);
    const EArr = zArr.map(zz => E_of_z(modelName, zz, p));
    const invE = EArr.map(e => 1/e);
    const Dc = (c_kms / p.H0) * trapz(zArr, invE);
    const DL = (1 + z) * Dc;
    return 5 * Math.log10(DL) + 25;
  }

  function H_of_z(z, modelName, p) {
    return p.H0 * E_of_z(modelName, z, p);
  }

  /* ========= PARAM GATHERING ========= */

  function readParamsFromUI() {
    const H0  = Number(document.getElementById("lab-h0").value || 67.4);
    const Om0 = Number(document.getElementById("lab-om0").value || 0.3);
    const Or0 = Number(document.getElementById("lab-or0").value || 0.0);
    const Ode0 = Number(document.getElementById("lab-ode0").value || 0.7);
    const flat = document.getElementById("lab-flat").checked;
    const zmax = Number(document.getElementById("lab-zmax").value || 3);
    const nsamples = Number(document.getElementById("lab-nsamples").value || 200);

    const wc  = Number(document.getElementById("lab-wc").value || -0.9);
    const w0  = Number(document.getElementById("lab-w0").value || -0.9);
    const wa  = Number(document.getElementById("lab-wa").value || 0.0);
    const K0  = Number(document.getElementById("lab-k0").value || 0.5);
    const pK  = Number(document.getElementById("lab-p").value || 1.0);

    return {
      H0, Om0, Or0, Ode0, flat,
      zmax, nsamples,
      wc, w0, wa, K0, pK
    };
  }

  /* ========= PLOTS ========= */

  function plotBackground(bgGrid, p) {
    const traces = [];
    Object.keys(bgGrid).forEach(model => {
      if (!state.models[model]) return;
      const bg = bgGrid[model];
      traces.push({
        x: bg.z,
        y: bg.E,
        mode: "lines",
        name: model.toUpperCase() + " ‚Äì E(z)"
      });
    });

    Plotly.newPlot("lab-plot-background", traces, {
      xaxis: { title: "z" },
      yaxis: { title: "E(z)", type: "linear" },
      margin: { t: 30 }
    }, {responsive:true});

    const zEval = Number(document.getElementById("lab-z-eval").value || 0.5);
    let summary = "Background values at z* = " + zEval.toFixed(3) + ":\n";
    Object.keys(bgGrid).forEach(model => {
      if (!state.models[model]) return;
      const Ez = E_of_z(model, zEval, p);
      const Hz = p.H0 * Ez;
      summary += "  " + model.toUpperCase() + ": E(z*) = " + Ez.toFixed(4) +
                 ", H(z*) ‚âà " + Hz.toFixed(2) + " km/s/Mpc\n";
    });
    document.getElementById("lab-info-background").textContent = summary;
  }

  function plotDistances(bgGrid, p) {
    const yq = document.getElementById("lab-yquantity").value;
    const traces = [];
    Object.keys(bgGrid).forEach(model => {
      if (!state.models[model]) return;
      const bg = bgGrid[model];

      const DL = bg.Dc.map((Dc,i) => (1 + bg.z[i]) * Dc);
      const DA = bg.Dc.map((Dc,i) => Dc / (1 + bg.z[i]));
      let y, label;

      if (yq === "DC") { y = bg.Dc; label = "D_C(z) [Mpc]"; }
      else if (yq === "DA") { y = DA; label = "D_A(z) [Mpc]"; }
      else if (yq === "DL") { y = DL; label = "D_L(z) [Mpc]"; }
      else if (yq === "mu") {
        y = DL.map(DL_i => 5 * Math.log10(DL_i) + 25);
        label = "Œº(z)";
      } else {
        y = bg.Dc;
        label = "D_C(z) [Mpc]";
      }

      traces.push({
        x: bg.z,
        y,
        mode: "lines",
        name: model.toUpperCase()
      });

      Plotly.newPlot("lab-plot-distances", traces, {
        xaxis: { title: "z" },
        yaxis: { title: label },
        margin: { t: 30 }
      }, {responsive:true});
    });

    document.getElementById("lab-info-distances").textContent =
      "Distances computed from comoving line-of-sight integral. Y quantity: " +
      document.getElementById("lab-yquantity").value;
  }

  function plotGrowth(bgGrid, p) {
    const yq = document.getElementById("lab-yquantity").value;
    const traces = [];
    Object.keys(bgGrid).forEach(model => {
      if (!state.models[model]) return;
      const bg = bgGrid[model];
      const gr = computeGrowthOnBackground(bg, p);
      let y, label;
      if (yq === "growthD_over_a") {
        y = gr.D.map((D,i) => D / gr.a[i]);
        label = "D(a)/a";
      } else {
        y = gr.D;
        label = "D(a)";
      }

      traces.push({
        x: gr.a,
        y,
        mode: "lines",
        name: model.toUpperCase()
      });
    });

    Plotly.newPlot("lab-plot-growth", traces, {
      xaxis: { title: "a" },
      yaxis: { title: yq === "growthD_over_a" ? "D(a)/a" : "D(a)" },
      margin: { t: 30 }
    }, {responsive:true});

    document.getElementById("lab-info-growth").textContent =
      "GR growth solved with D'' + (2+H'/H)D' - 3/2 Œ©_m(a) D = 0, normalized to D(a=1)=1.";
  }

  function plotQKDEDiagnostics(bgGrid, p) {
    if (!state.models.qkde || !bgGrid.qkde) {
      document.getElementById("lab-info-qkde").textContent =
        "Enable QKDE model to see diagnostics.";
      Plotly.newPlot("lab-plot-qkde", [], {margin:{t:30}}, {responsive:true});
      return;
    }
    const bg = bgGrid.qkde;
    const aArr = bg.a;
    const zArr = bg.z;
    const K0 = p.K0;
    const pK = p.pK;

    const Ka = aArr.map(a => 1 + K0 * Math.pow(a, -pK));
    const dlnK_dlnA = aArr.map(a => {
      const K = 1 + K0 * Math.pow(a, -pK);
      const dK_dlnA = -pK * K0 * Math.pow(a, -pK);
      return dK_dlnA / K;
    });
    const w_eff = dlnK_dlnA.map(v => -1 - v/3);

    const traceK = {
      x: zArr, y: Ka,
      name: "K(a)",
      mode: "lines",
      yaxis: "y1"
    };

    const tracew = {
      x: zArr, y: w_eff,
      name: "w_eff(a)",
      mode: "lines",
      yaxis: "y2"
    };

    Plotly.newPlot("lab-plot-qkde", [traceK, tracew], {
      xaxis: { title: "z" },
      yaxis: { title: "K(a)", side: "left" },
      yaxis2: {
        title: "w_eff(a)",
        overlaying: "y",
        side: "right"
      },
      margin: { t: 30 }
    }, {responsive:true});

    document.getElementById("lab-info-qkde").textContent =
      "K(a) = 1 + K0 a^{-p}, w_eff(a) = -1 - (1/3) d ln K / d ln a.\n" +
      "When K is constant, w_eff ‚Üí -1 and QKDE reduces to ŒõCDM.";
  }

  function plotDataVsModels(bgGrid, p) {
    const target = document.getElementById("lab-fit-target").value;
    const traces = [];

    // Model prediction trace
    Object.keys(bgGrid).forEach(model => {
      if (!state.models[model]) return;
      const bg = bgGrid[model];
      let x, y, label;

      if (target === "sn") {
        const DL = bg.Dc.map((Dc,i) => (1 + bg.z[i]) * Dc);
        x = bg.z;
        y = DL.map(DL_i => 5 * Math.log10(DL_i) + 25);
        label = model.toUpperCase() + " Œº(z)";
      } else if (target === "hz") {
        x = bg.z;
        y = bg.Hz;
        label = model.toUpperCase() + " H(z)";
      } else {
        x = bg.z;
        y = bg.Dc;
        label = model.toUpperCase() + " D_C(z)";
      }

      traces.push({
        x, y,
        mode: "lines",
        name: label
      });
    });

    // Data trace
    const data = state.data[target];
    if (data && data.rows.length) {
      let xd = [], yd = [], errd = [];
      if (target === "sn") {
        for (const r of data.rows) {
          xd.push(r.z);
          yd.push(r.mu);
          errd.push(r.sigma_mu);
        }
      } else if (target === "hz") {
        for (const r of data.rows) {
          xd.push(r.z);
          yd.push(r.Hz);
          errd.push(r.sigma_Hz);
        }
      }

      if (xd.length) {
        traces.push({
          x: xd,
          y: yd,
          error_y: { type: "data", array: errd, visible: true },
          mode: "markers",
          name: target.toUpperCase() + " data"
        });
      }
    }

    Plotly.newPlot("lab-plot-data", traces, {
      xaxis: { title: "z" },
      yaxis: { title: target.toUpperCase() + " observable" },
      margin: { t: 30 }
    }, {responsive:true});

    document.getElementById("lab-info-data").textContent =
      "Data target: " + target.toUpperCase() +
      ". Models shown: " + Object.keys(bgGrid).filter(m => state.models[m]).join(", ");
  }

  function updateSummary(bgGrid, p, chi2Results) {
    const zEval = Number(document.getElementById("lab-z-eval").value || 0.5);
    let text = "";
    text += "=== Current Parameters ===\n";
    text += "H0   = " + p.H0 + " km/s/Mpc\n";
    text += "Om0  = " + p.Om0 + "\n";
    text += "Or0  = " + p.Or0 + "\n";
    text += "Ode0 = " + p.Ode0 + "\n";
    text += "Flat = " + (p.flat ? "yes" : "no") + "\n\n";

    text += "=== Background at z* = " + zEval.toFixed(3) + " ===\n";
    Object.keys(bgGrid).forEach(model => {
      if (!state.models[model]) return;
      const Ez = E_of_z(model, zEval, p);
      const Hz = p.H0 * Ez;
      text += model.toUpperCase() + ": E(z*) = " + Ez.toFixed(4) +
              ", H(z*) ‚âà " + Hz.toFixed(2) + " km/s/Mpc\n";
    });

    if (chi2Results && chi2Results.length) {
      text += "\n=== œá¬≤ (current params) ===\n";
      chi2Results.forEach(r => {
        if (r.chi2 === null) return;
        text += r.model.toUpperCase() + " vs " + r.target.toUpperCase() +
                ": œá¬≤ = " + r.chi2.toFixed(2) +
                " for " + r.ndof + " points\n";
      });
    }

    document.getElementById("lab-info-summary").textContent = text;
  }

  /* ========= EVENT WIRING ========= */

  function setUpEvents() {
    // Model toggles
    document.querySelectorAll(".lab-model-toggle").forEach(el => {
      el.addEventListener("change", () => {
        const m = el.getAttribute("data-model");
        state.models[m] = el.checked;
      });
    });

    // Tabs
    document.querySelectorAll(".lab-tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        document.querySelectorAll(".lab-tab-btn").forEach(b => b.classList.remove("is-active"));
        btn.classList.add("is-active");
        document.querySelectorAll(".lab-panel").forEach(p => {
          p.hidden = p.getAttribute("data-tab") !== tab;
        });
      });
    });

    // File inputs
    const fileMap = {
      "lab-data-sn": "sn",
      "lab-data-bao": "bao",
      "lab-data-hz": "hz",
      "lab-data-fs8": "fs8"
    };
    Object.keys(fileMap).forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("change", (ev) => {
        const file = ev.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const parsed = parseCSV(reader.result);
          state.data[fileMap[id]] = parsed;
          document.getElementById("lab-chi2-output").textContent =
            "Loaded " + (parsed ? parsed.rows.length : 0) +
            " rows for " + fileMap[id].toUpperCase() + ".";
        };
        reader.readAsText(file);
      });
    });

    // Update plots
    document.getElementById("lab-update-plots").addEventListener("click", () => {
      const p = readParamsFromUI();
      state.params = p;
      const bg = computeBackgroundGrid(p);
      plotBackground(bg, p);
      plotDistances(bg, p);
      plotGrowth(bg, p);
      plotQKDEDiagnostics(bg, p);
      plotDataVsModels(bg, p);
      updateSummary(bg, p, null);
    });

    // œá¬≤ button
    document.getElementById("lab-fit-chi2").addEventListener("click", () => {
      const p = readParamsFromUI();
      state.params = p;
      const bg = computeBackgroundGrid(p);
      const target = document.getElementById("lab-fit-target").value;
      const results = [];
      Object.keys(bg).forEach(model => {
        if (!state.models[model]) return;
        const res = computeChi2(target, model, bg, null, p);
        results.push({ model, target, ...res });
      });
      let msg = "";
      results.forEach(r => {
        if (r.chi2 === null) {
          msg += r.model.toUpperCase() + ": " + (r.message || "no œá¬≤") + "\n";
        } else {
          msg += r.model.toUpperCase() + ": œá¬≤ = " + r.chi2.toFixed(2) +
                 " for " + r.ndof + " points\n";
        }
      });
      document.getElementById("lab-chi2-output").textContent = msg;
      updateSummary(bg, p, results);
      plotDataVsModels(bg, p);
    });

    // Initial plot on load
    document.getElementById("lab-update-plots").click();
  }

  document.addEventListener("DOMContentLoaded", setUpEvents);
})();
</script>

</body>
</html>
